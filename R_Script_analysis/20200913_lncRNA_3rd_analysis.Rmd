---
title: "lncRNA 3rd"
author: "Skim"
date: '2020 9 13 '
output: 
  html_document:
    df_print: paged
    toc: true
    toc_depth: 4
    toc_float: false
    code_folding: hide
---

This report is for re-analysis of DE lncRNAs by edgeR (Previous was MAST). As Nikos recommended to do permutation test for some lncRNA, I also add in the report. 

Genes in here are DE & specific to cell type

Neat1 [ref](https://link.springer.com/article/10.1007/s00018-019-03074-9)

lncRNA in AD [ref](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6262561/#:~:text=Abstract,promising%20therapeutic%20targets%20for%20treatment)

lncRNA in AD2 [ref](https://www.tandfonline.com/doi/epub/10.1080/15476286.2020.1788848?needAccess=true)

lncRNA in CNS injuries [ref](https://www.cell.com/molecular-therapy-family/nucleic-acids/pdf/S2162-2531(19)30203-3.pdf)

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
library(Seurat)
library(edgeR)
library(dplyr)
library(tidyverse)
library(irr)
library(tidyr)
library(scran)
library(scales)
library(gridExtra)
library(DT)
```


```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
load(file="/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/20200210_figures_for_meeting_report_cleaned_Seurat_object_res0.8.Robj")

avg.df <- read.table(file = "/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/20200430_lncRNAs_2nd_analysis_avg.txt", sep = "\t")

```

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
# # load biotype
# seurat_mouse_genes <- read.table(file = "/data/rajewsky/home/skim/Microglia_Heppner/Bulk_transcriptome/R_Scripts/20200312_Bulk_Correlation_mouse_genes_bio_type_biomaRt.txt")
# 
# # narrow down biotype
# seurat_mouse_genes$gene_biotype_global <- ifelse(seurat_mouse_genes$gene_biotype %in% c("IG_V_gene", "IG_C_gene"), "IG_gene",
#                                                  ifelse(seurat_mouse_genes$gene_biotype %in% c("pseudogene",
#                                                                                                "unprocessed_pseudogene",
#                                                                                                "processed_pseudogene",
#                                                                                                "transcribed_unprocessed_pseudogene",
#                                                                                                "transcribed_processed_pseudogene",
#                                                                                                "unitary_pseudogene", 
#                                                                                                "transcribed_unitary_pseudogene",
#                                                                                                "polymorphic_pseudogene", 
#                                                                                                "TR_V_pseudogene"), "pseudogene",
#                                                  ifelse(seurat_mouse_genes$gene_biotype %in% c("TR_V_gene", "TR_C_gene"), "TR_gene",
#                                                  ifelse(seurat_mouse_genes$gene_biotype %in% c("protein_coding"), "protein_coding",
#                                                  ifelse(seurat_mouse_genes$gene_biotype %in% c("TEC"), "TEC",
#                                                  ifelse(seurat_mouse_genes$gene_biotype %in% c("lncRNA"), "lncRNA", "ncRNA"))))))
# 
# 
# load(file="/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/Seurat_object/20200501_Seurat_object_Ctrl_Robj")
# load(file="/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/Seurat_object/20200501_Seurat_object_AD_Robj")
# load(file="/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/Seurat_object/20200501_Seurat_object_ADp40KO_Robj")
# # 
# # # calculate all sum of three samples
# data9set_cleaned_Ctrl_sum.df <- as.data.frame(Matrix::rowSums(GetAssayData(object = data9set_cleaned_Ctrl.SO, slot = 'counts')))
# data9set_cleaned_AD_sum.df <- as.data.frame(Matrix::rowSums(GetAssayData(object = data9set_cleaned_AD.SO, slot = 'counts')))
# data9set_cleaned_ADp40KO_sum.df <- as.data.frame(Matrix::rowSums(GetAssayData(object = data9set_cleaned_ADp40KO.SO, slot = 'counts')))
# 
# # merge into one DF
# data9set_cleaned_sum.df <- cbind(data9set_cleaned_Ctrl_sum.df, data9set_cleaned_AD_sum.df, data9set_cleaned_ADp40KO_sum.df)
# colnames(data9set_cleaned_sum.df) <- c("Ctrl_counts_sum", "AD_counts_sum", "ADp40KO_counts_sum")
# 
# data9set_cleaned_sum.df$mgi_symbol <- rownames(data9set_cleaned_sum.df)
# 
# # Join to biotypes
# data9set_cleaned_sum.df <- inner_join(data9set_cleaned_sum.df, seurat_mouse_genes, by = "mgi_symbol")
# data9set_cleaned_sum.df$sums <- rowSums(data9set_cleaned_sum.df[,c(1:3)])
# 
# 
# DGEm <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/Bulk_transcriptome/R_Scripts/20200311_Bulk_Analysis_Modified_Final_DF.csv", row.names =1, sep = ",", check.names = FALSE)
# 
# DGEm$gene <- rownames(DGEm)
# 
# DGEm2 <- data.frame(WT = DGEm$`WT-1` + DGEm$`WT-2` + DGEm$`WT-3`, AD = DGEm$`AD-1` + DGEm$`AD-2`+ DGEm$`AD-3`, ADp40KO = DGEm$`ADp40KO-1` + DGEm$`ADp40KO-2` + DGEm$`ADp40KO-3`, row.names = rownames(DGEm))
# 
# DGEm2$mgi_symbol <- rownames(DGEm2)
# 
# data_sum_final.df <- inner_join(data9set_cleaned_sum.df, DGEm2, by = "mgi_symbol")
# 
# # only lncRNAs
# data_lncRNA_sum_final.df <- data_sum_final.df[data_sum_final.df$gene_biotype_global %in% "lncRNA", ]
# 
# # 1st high expressed 
# data_lncRNA_cleaned_sum_final.df <- data_lncRNA_sum_final.df[data_lncRNA_sum_final.df$WT > 15, ]
# # 2nd low expressed
# data_lncRNA_cleaned_sum_final.df2 <- data_lncRNA_sum_final.df[data_lncRNA_sum_final.df$WT <= 15, ]
# 
# avg.df$gene <- rownames(avg.df)
# 
# # Higly expressed in bulk
# avg_lncRNA.df <- avg.df[avg.df$gene %in% data_lncRNA_cleaned_sum_final.df$mgi_symbol, ] 
# avg_lncRNA.df$gene <- NULL
# avg_lncRNA.df <- avg_lncRNA.df[rowSums(avg_lncRNA.df) !=0, ]
# 
# write.csv(avg_lncRNA.df, file = "/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/20200913_lncRNA_3rd_analysis/avg_lncRNA.csv")

avg_lncRNA.df <- read.csv(file = "/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/20200913_lncRNA_3rd_analysis/avg_lncRNA.csv", row.names = 1)


#####################
# calculate z-score
#####################

# calculate z-score (high)
avg_lncRNA_z_score.df <- as.data.frame(t(apply(avg_lncRNA.df, 1, function(x) (x - mean(x)) / sd(x))))


avg_lncRNA_z_score.df$gene <- rownames(avg_lncRNA_z_score.df)
avg_lncRNA_z_score.df$gene <- NULL
```

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
for(i in c(1:2358)){
  avg_lncRNA_z_score.df[i,"specificity"] <- ifelse(ncol(avg_lncRNA_z_score.df[i,c(1:6)] %>% select_if(~any(. > 1))) == 1 && ncol(avg_lncRNA_z_score.df[i,c(1:6) ] %>% select_if(~any(. < 0))) > 3, "specific", "not_specific")
  
  avg_lncRNA_z_score.df[i,"cell_type_specific"] <- ifelse(ncol(avg_lncRNA_z_score.df[i,c(1)] %>% as.data.frame %>% select_if(~any(. > 1))) == 1 && ncol(avg_lncRNA_z_score.df[i,c(2:6) ] %>% select_if(~any(. < 0))) > 3, "Excitatory", ifelse(ncol(avg_lncRNA_z_score.df[i,c(2)] %>% as.data.frame %>% select_if(~any(. > 1))) == 1 && ncol(avg_lncRNA_z_score.df[i,c(1,3:6) ] %>% select_if(~any(. < 0))) > 3, "Inhibitory", ifelse(ncol(avg_lncRNA_z_score.df[i,c(3)] %>% as.data.frame %>% select_if(~any(. > 1))) == 1 && ncol(avg_lncRNA_z_score.df[i,c(1:2,4:6) ] %>% select_if(~any(. < 0))) > 3, "Oligo", ifelse(ncol(avg_lncRNA_z_score.df[i,c(4)] %>% as.data.frame %>%select_if(~any(. > 1))) == 1 && ncol(avg_lncRNA_z_score.df[i,c(1:3,5:6) ] %>% select_if(~any(. < 0))) > 3, "OPC",
                                                          ifelse(ncol(avg_lncRNA_z_score.df[i,c(5)] %>% as.data.frame %>% select_if(~any(. > 1))) == 1 && ncol(avg_lncRNA_z_score.df[i,c(1:4,6) ] %>% select_if(~any(. < 0))) > 3, "Microglia",ifelse(ncol(avg_lncRNA_z_score.df[i,c(6)] %>% as.data.frame %>% select_if(~any(. > 1))) == 1 && ncol(avg_lncRNA_z_score.df[i,c(1:5) ] %>% select_if(~any(. < 0))) > 3, "Astrocytes", "not_specific"))))))
  }

avg_lncRNA_z_score.df$gene <- rownames(avg_lncRNA_z_score.df)
```

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
z_score_from_gene_list <- function(Seurat.SO, gene_list){
  
  df <- as.data.frame(Matrix::rowMeans(GetAssayData(Seurat.SO, slot = "data")))
  df$gene <- rownames(df)
  df <- df[rownames(df) %in% gene_list,]
  return(df)
}

AD_lnc <- c("Neat1", "Meg3", "Rmst", "Sox2ot", "Miat", "Snhg1", "Gm4419", "Pvt1")

```

### 1. Microglia

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
AD_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/Microglia_AD_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_Ctrl.df2 <- AD_Ctrl.df[AD_Ctrl.df$gene %in% AD_lnc, ]
# select lncRNAs
AD_Ctrl.df <- AD_Ctrl.df[AD_Ctrl.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Microglia", ]), ]
# statistical significant
AD_Ctrl.df <- AD_Ctrl.df[which(abs(AD_Ctrl.df$logFC) > 0.25 & AD_Ctrl.df$FDR < 0.05),]

AD_ADp40KO.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/Microglia_AD_ADp40KO.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_ADp40KO.df2 <- AD_ADp40KO.df[AD_ADp40KO.df$gene %in% AD_lnc, ]
# select lncRNAs
AD_ADp40KO.df <- AD_ADp40KO.df[AD_ADp40KO.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Microglia", ]), ]
# statistical significant
AD_ADp40KO.df <- AD_ADp40KO.df[which(abs(AD_ADp40KO.df$logFC) > 0.25 & AD_ADp40KO.df$FDR < 0.05),]


ADp40KO_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/Microglia_ADp40KO_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
ADp40KO_Ctrl.df2 <- ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$gene %in% AD_lnc, ]
# select lncRNAs
ADp40KO_Ctrl.df <- ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Microglia", ]), ]
# statistical significant
ADp40KO_Ctrl.df <- ADp40KO_Ctrl.df[which(abs(ADp40KO_Ctrl.df$logFC) > 0.25 & ADp40KO_Ctrl.df$FDR < 0.05),]
 
genes <- c(AD_Ctrl.df[AD_Ctrl.df$logFC > 0, ]$gene, 
           ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$logFC > 0, ]$gene, AD_ADp40KO.df[AD_ADp40KO.df$logFC > 0, ]$gene,
           AD_ADp40KO.df[AD_ADp40KO.df$logFC < 0, ]$gene, 
           ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$logFC < 0, ]$gene, AD_Ctrl.df[AD_Ctrl.df$logFC < 0, ]$gene) %>% unique

genes <- factor(genes, levels = genes)
```

AD vs WT

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_Ctrl.df2[,c(6:11)])
```

AD vs ADp40KO

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_ADp40KO.df2[,c(6:11)])
```

ADp40KO vs WT

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(ADp40KO_Ctrl.df2[,c(6:11)])
```

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
data9set_cleaned.SO$cell_type <- data9set_cleaned.SO@active.ident
#table(data9set_cleaned.SO$cell_type)

data9set_sub.SO <- subset(data9set_cleaned.SO, subset = cell_type %in% c("Microglia"))

##########################
# z-score for each sample
##########################
data9set_sub_1.SO <- subset(data9set_sub.SO, subset = sample %in% "Ctrl")
data9set_sub_2.SO <- subset(data9set_sub.SO, subset = sample %in% "AD")
data9set_sub_3.SO <- subset(data9set_sub.SO, subset = sample %in% "ADp40KO")

########################
# expression calculation
########################
df1 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_1.SO, slot = "data")))
df1$gene <- rownames(df1)
colnames(df1) <- c("WT", "gene")

df2 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_2.SO, slot = "data")))
df2$gene <- rownames(df2)
colnames(df2) <- c("APPPS1", "gene")

df3 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_3.SO, slot = "data")))
df3$gene <- rownames(df3)
colnames(df3) <- c("APPPS1.il12b-/-", "gene")

df <- merge(df1, c(df2, df3))
df$gene.1 <- NULL

ZS.df1 <- z_score_from_gene_list(data9set_sub_1.SO, genes)
colnames(ZS.df1) <- c("WT", "gene")
ZS.df2 <- z_score_from_gene_list(data9set_sub_2.SO, genes)
colnames(ZS.df2) <- c("APPPS1", "gene")
ZS.df3 <- z_score_from_gene_list(data9set_sub_3.SO, genes)
colnames(ZS.df3) <- c("APPPS1.il12b-/-", "gene")

# merge all data frame
ZS.df <- merge(ZS.df1, c(ZS.df2, ZS.df3), by = "gene")

ZS.df$gene.1 <- NULL
rownames(ZS.df) <- ZS.df$gene
ZS.df$gene <- NULL

sub_ZS.df <- apply(ZS.df, 1, function(x) (x - mean(x)) / sd(x))
sub_ZS.df <- data.frame(t(sub_ZS.df))
sub_ZS.df$gene <- rownames(sub_ZS.df)

sub_ZS.df <- gather(sub_ZS.df, sample, z_score, "WT":"APPPS1.il12b...")

sub_zs.df2 <- left_join(sub_ZS.df, df, by = "gene")

sub_zs.df2$gene <- factor(sub_zs.df2$gene, levels = genes)

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
g1 <- ggplot(data = sub_zs.df2, mapping = aes(x = sample, y = gene, fill = z_score)) +
  geom_tile() + scale_y_discrete(position = "right")  + coord_flip() +  theme_classic() + theme(plot.title = element_text(size = 15, hjust = 0.5), 
                                        axis.title.y = element_blank(),
                                         axis.title.x = element_blank(),
                                         axis.text.x.top = element_text(angle = 90, vjust = 0.5, size = 12, color = "black"),
                                         axis.text.y = element_text(size = 12, color = "black"),
                                         axis.line = element_line(color = "white"),
                                         axis.ticks = element_line(color = "white"),
                                         legend.title = element_text(size = 11, color = "white"),
                                         legend.text = element_text(size = 11, color = "black"),
                                         panel.spacing = unit(0, "mm"), 
                                        panel.margin= unit(c(-1.1), "mm"), 
                                        plot.margin = margin(0, 0, 0, 0, "cm"),
                                        strip.background = element_blank(),
                                        strip.text.x = element_text(size = .2, color = "white")) + 
  #scale_fill_gradient2(low="red", high='blue', mid="white", midpoint = 0) +  
  #scale_fill_gradientn("expression", colours = c("#003366", "#FFCC66", "#990000"), limits = c(-1.5, 1.5), oob=squish)
  scale_fill_viridis_c("expression", limits=c(-1.5, 1.5), na.value = "#FDE725FF", labels = c("-1.5", "-1","-0.5","0","0.5", "1", "1.5"), oob=squish)

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
sub_zs.df3 <- sub_zs.df2[,c(1:2, 4:6)]

sub_zs.df3 <- gather(sub_zs.df3, sample, expression, "WT":"APPPS1.il12b...")

g2 <- ggplot(data = sub_zs.df3, mapping = aes(x = sample, y = gene, fill = expression)) +
  geom_tile() + scale_y_discrete(position = "right")  + coord_flip() +  theme_classic() +
  theme(plot.title = element_text(size = 15, hjust = 0.5), 
                                        axis.title.y = element_blank(),
                                         axis.title.x = element_blank(),
                                         axis.text.x = element_blank(),
                                         axis.text.y = element_text(size = 12, color = "black"),
                                         axis.line = element_line(color = "white"),
                                         axis.ticks = element_line(color = "white"),
                                         legend.title = element_text(size = 11, color = "black"),
                                         legend.text = element_text(size = 11, color = "black"),
                                         panel.spacing = unit(0, "mm"), 
                                        panel.margin= unit(c(-1.1), "mm"), 
                                        plot.margin = margin(0, 0, 0, 0, "cm"),
                                        strip.background = element_blank(),
                                        strip.text.x = element_text(size = 10, color = "black")) + 
  #scale_fill_gradient2(low="red", high='blue', mid="white", midpoint = 0) +  
  scale_fill_gradientn("expression", colours = c("#003366", "#FFCC66", "#990000"), limits = c(0, 3), oob=squish)



grid.arrange(g1, g2, ncol = 1, heights=c(5,2))
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
ZS.df1 <- z_score_from_gene_list(data9set_sub_1.SO, AD_lnc)
colnames(ZS.df1) <- c("WT", "gene")
ZS.df2 <- z_score_from_gene_list(data9set_sub_2.SO, AD_lnc)
colnames(ZS.df2) <- c("APPPS1", "gene")
ZS.df3 <- z_score_from_gene_list(data9set_sub_3.SO, AD_lnc)
colnames(ZS.df3) <- c("APPPS1.il12b-/-", "gene")

# merge all data frame
ZS.df <- merge(ZS.df1, c(ZS.df2, ZS.df3), by = "gene")

ZS.df$gene.1 <- NULL
rownames(ZS.df) <- ZS.df$gene
ZS.df$gene <- NULL

sub_ZS.df <- apply(ZS.df, 1, function(x) (x - mean(x)) / sd(x))
sub_ZS.df <- data.frame(t(sub_ZS.df))
sub_ZS.df$gene <- rownames(sub_ZS.df)

sub_ZS.df <- gather(sub_ZS.df, sample, z_score, "WT":"APPPS1.il12b...")

sub_zs.df2 <- left_join(sub_ZS.df, df, by = "gene")

sub_zs.df2$gene <- factor(sub_zs.df2$gene, levels = AD_lnc)

sub_zs.df2$cell_type <- "Microglia"

AD_lnc_MG <- sub_zs.df2

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
permutation_test <- function(compare = "AD_WT", test_gene = "Meg3"){
  perm_df1_sub <- perm_df1[rownames(perm_df1) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df1_sub$exp <- "WT"
  colnames(perm_df1_sub) <- c("gene", "exp")
  
  perm_df2_sub <- perm_df2[rownames(perm_df2) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df2_sub$exp <- "APPPS1"
  colnames(perm_df2_sub) <- c("gene", "exp")
  
  perm_df3_sub <- perm_df3[rownames(perm_df3) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df3_sub$exp <- "APPPS1.il12b-/-"
  colnames(perm_df3_sub) <- c("gene", "exp")
  
  perm_df_sub <- rbind(perm_df1_sub, perm_df2_sub) 
  
## for reproducibility
  set.seed(101) 
  nsim <- 1000
  res <- numeric(nsim) ## set aside space for results
  for (i in 1:nsim) {
    ## standard approach: scramble response value
      perm <- sample(nrow(perm_df_sub))
      bdat <- transform(perm_df_sub, gene = gene[perm])
    ## compute & store difference in means; store the value
      res[i] <- mean(bdat[bdat$exp =="WT",]$gene)-
          mean(bdat[bdat$exp =="APPPS1",]$gene)
}
  
  res.df <- as.data.frame(res) 
  res.df$test <- "permutation"
  obs <- mean(perm_df_sub[perm_df_sub$exp == "APPPS1",]$gene)- mean(perm_df_sub[perm_df_sub$exp == "WT",]$gene)
  obs.df <- as.data.frame(obs)
  colnames(obs.df) <- "res"
  obs.df$test <- "observation"
  
  res.df <- rbind(res.df, obs.df)
  
  return(res.df)
  
}

permutation_test2 <- function(compare = "AD_ADp40KO", test_gene = "Meg3"){
  perm_df1_sub <- perm_df1[rownames(perm_df1) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df1_sub$exp <- "WT"
  colnames(perm_df1_sub) <- c("gene", "exp")
  
  perm_df2_sub <- perm_df2[rownames(perm_df2) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df2_sub$exp <- "APPPS1"
  colnames(perm_df2_sub) <- c("gene", "exp")
  
  perm_df3_sub <- perm_df3[rownames(perm_df3) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df3_sub$exp <- "APPPS1.il12b-/-"
  colnames(perm_df3_sub) <- c("gene", "exp")

  perm_df_sub <- rbind(perm_df2_sub, perm_df3_sub)
  
## for reproducibility
  set.seed(101) 
  nsim <- 1000
  res <- numeric(nsim) ## set aside space for results
  for (i in 1:nsim) {
    ## standard approach: scramble response value
      perm <- sample(nrow(perm_df_sub))
      bdat <- transform(perm_df_sub, gene = gene[perm])
    ## compute & store difference in means; store the value
      res[i] <- mean(bdat[bdat$exp =="APPPS1",]$gene)-
          mean(bdat[bdat$exp =="APPPS1.il12b-/-",]$gene)
}
  
  res.df <- as.data.frame(res) 
  res.df$test <- "permutation"
  obs <- mean(perm_df_sub[perm_df_sub$exp == "APPPS1",]$gene)- mean(perm_df_sub[perm_df_sub$exp == "APPPS1.il12b-/-",]$gene)
  obs.df <- as.data.frame(obs)
  colnames(obs.df) <- "res"
  obs.df$test <- "observation"
  
  res.df <- rbind(res.df, obs.df)
  
  return(res.df)
  
}

permutation_test3 <- function(compare = "ADp40KO_WT", test_gene = "Meg3"){
  perm_df1_sub <- perm_df1[rownames(perm_df1) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df1_sub$exp <- "WT"
  colnames(perm_df1_sub) <- c("gene", "exp")
  
  perm_df2_sub <- perm_df2[rownames(perm_df2) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df2_sub$exp <- "APPPS1"
  colnames(perm_df2_sub) <- c("gene", "exp")
  
  perm_df3_sub <- perm_df3[rownames(perm_df3) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df3_sub$exp <- "APPPS1.il12b-/-"
  colnames(perm_df3_sub) <- c("gene", "exp")

  perm_df_sub <- rbind(perm_df1_sub, perm_df3_sub)
  
## for reproducibility
  set.seed(101) 
  nsim <- 1000
  res <- numeric(nsim) ## set aside space for results
  for (i in 1:nsim) {
    ## standard approach: scramble response value
      perm <- sample(nrow(perm_df_sub))
      bdat <- transform(perm_df_sub, gene = gene[perm])
    ## compute & store difference in means; store the value
      res[i] <- mean(bdat[bdat$exp =="APPPS1.il12b-/-",]$gene)-
          mean(bdat[bdat$exp =="WT",]$gene)
}
  
  res.df <- as.data.frame(res) 
  res.df$test <- "permutation"
  obs <- mean(perm_df_sub[perm_df_sub$exp == "APPPS1.il12b-/-",]$gene)- mean(perm_df_sub[perm_df_sub$exp == "WT",]$gene)
  obs.df <- as.data.frame(obs)
  colnames(obs.df) <- "res"
  obs.df$test <- "observation"
  
  res.df <- rbind(res.df, obs.df)
  
  return(res.df)
  
}
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
permutation_test_without_zero <- function(compare = "AD_WT", test_gene = "Meg3"){
  perm_df1_sub <- perm_df1[rownames(perm_df1) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df1_sub$exp <- "WT"
  colnames(perm_df1_sub) <- c("gene", "exp")
  perm_df1_sub <- perm_df1_sub[perm_df1_sub$gene > 0, ]
  
  perm_df2_sub <- perm_df2[rownames(perm_df2) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df2_sub$exp <- "APPPS1"
  colnames(perm_df2_sub) <- c("gene", "exp")
  perm_df2_sub <- perm_df2_sub[perm_df2_sub$gene > 0, ]
  
  perm_df3_sub <- perm_df3[rownames(perm_df3) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df3_sub$exp <- "APPPS1.il12b-/-"
  colnames(perm_df3_sub) <- c("gene", "exp")
  perm_df3_sub <- perm_df3_sub[perm_df3_sub$gene > 0, ]
  
  perm_df_sub <- rbind(perm_df1_sub, perm_df2_sub) 
  
## for reproducibility
  set.seed(101) 
  nsim <- 1000
  res <- numeric(nsim) ## set aside space for results
  for (i in 1:nsim) {
    ## standard approach: scramble response value
      perm <- sample(nrow(perm_df_sub))
      bdat <- transform(perm_df_sub, gene = gene[perm])
    ## compute & store difference in means; store the value
      res[i] <- mean(bdat[bdat$exp =="WT",]$gene)-
          mean(bdat[bdat$exp =="APPPS1",]$gene)
}
  
  res.df <- as.data.frame(res) 
  res.df$test <- "permutation"
  obs <- mean(perm_df_sub[perm_df_sub$exp == "APPPS1",]$gene)- mean(perm_df_sub[perm_df_sub$exp == "WT",]$gene)
  obs.df <- as.data.frame(obs)
  colnames(obs.df) <- "res"
  obs.df$test <- "observation"
  
  res.df <- rbind(res.df, obs.df)
  
  return(res.df)
  
}

permutation_test_without_zero2 <- function(compare = "AD_ADp40KO", test_gene = "Meg3"){
  perm_df1_sub <- perm_df1[rownames(perm_df1) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df1_sub$exp <- "WT"
  colnames(perm_df1_sub) <- c("gene", "exp")
  perm_df1_sub <- perm_df1_sub[perm_df1_sub$gene > 0, ]
  
  perm_df2_sub <- perm_df2[rownames(perm_df2) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df2_sub$exp <- "APPPS1"
  colnames(perm_df2_sub) <- c("gene", "exp")
  perm_df2_sub <- perm_df2_sub[perm_df2_sub$gene > 0, ]
  
  perm_df3_sub <- perm_df3[rownames(perm_df3) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df3_sub$exp <- "APPPS1.il12b-/-"
  colnames(perm_df3_sub) <- c("gene", "exp")
  perm_df3_sub <- perm_df3_sub[perm_df3_sub$gene > 0, ]
  
  perm_df_sub <- rbind(perm_df2_sub, perm_df3_sub)
  
## for reproducibility
  set.seed(101) 
  nsim <- 1000
  res <- numeric(nsim) ## set aside space for results
  for (i in 1:nsim) {
    ## standard approach: scramble response value
      perm <- sample(nrow(perm_df_sub))
      bdat <- transform(perm_df_sub, gene = gene[perm])
    ## compute & store difference in means; store the value
      res[i] <- mean(bdat[bdat$exp =="APPPS1",]$gene)-
          mean(bdat[bdat$exp =="APPPS1.il12b-/-",]$gene)
}
  
  res.df <- as.data.frame(res) 
  res.df$test <- "permutation"
  obs <- mean(perm_df_sub[perm_df_sub$exp == "APPPS1",]$gene)- mean(perm_df_sub[perm_df_sub$exp == "APPPS1.il12b-/-",]$gene)
  obs.df <- as.data.frame(obs)
  colnames(obs.df) <- "res"
  obs.df$test <- "observation"
  
  res.df <- rbind(res.df, obs.df)
  
  return(res.df)
  
}

permutation_test_without_zero3 <- function(compare = "ADp40KO_WT", test_gene = "Meg3"){
  perm_df1_sub <- perm_df1[rownames(perm_df1) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df1_sub$exp <- "WT"
  colnames(perm_df1_sub) <- c("gene", "exp")
  perm_df1_sub <- perm_df1_sub[perm_df1_sub$gene > 0, ]
  
  perm_df2_sub <- perm_df2[rownames(perm_df2) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df2_sub$exp <- "APPPS1"
  colnames(perm_df2_sub) <- c("gene", "exp")
  perm_df2_sub <- perm_df2_sub[perm_df2_sub$gene > 0, ]
  
  perm_df3_sub <- perm_df3[rownames(perm_df3) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df3_sub$exp <- "APPPS1.il12b-/-"
  colnames(perm_df3_sub) <- c("gene", "exp")
  perm_df3_sub <- perm_df3_sub[perm_df3_sub$gene > 0, ]
  
  perm_df_sub <- rbind(perm_df1_sub, perm_df3_sub)
  
## for reproducibility
  set.seed(101) 
  nsim <- 1000
  res <- numeric(nsim) ## set aside space for results
  for (i in 1:nsim) {
    ## standard approach: scramble response value
      perm <- sample(nrow(perm_df_sub))
      bdat <- transform(perm_df_sub, gene = gene[perm])
    ## compute & store difference in means; store the value
      res[i] <- mean(bdat[bdat$exp =="APPPS1.il12b-/-",]$gene)-
          mean(bdat[bdat$exp =="WT",]$gene)
}
  
  res.df <- as.data.frame(res) 
  res.df$test <- "permutation"
  obs <- mean(perm_df_sub[perm_df_sub$exp == "APPPS1.il12b-/-",]$gene)- mean(perm_df_sub[perm_df_sub$exp == "WT",]$gene)
  obs.df <- as.data.frame(obs)
  colnames(obs.df) <- "res"
  obs.df$test <- "observation"
  
  res.df <- rbind(res.df, obs.df)
  
  return(res.df)
  
}
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
hist_ttest <- function(compare = "ADp40KO_WT", test_gene = "Meg3"){
  perm_df1_sub <- perm_df1[rownames(perm_df1) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df1_sub$exp <- "WT"
  colnames(perm_df1_sub) <- c("gene", "exp")
  
  perm_df2_sub <- perm_df2[rownames(perm_df2) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df2_sub$exp <- "APPPS1"
  colnames(perm_df2_sub) <- c("gene", "exp")
  
  perm_df3_sub <- perm_df3[rownames(perm_df3) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df3_sub$exp <- "APPPS1.il12b-/-"
  colnames(perm_df3_sub) <- c("gene", "exp")
  
  perm_df_sub <- rbind(perm_df1_sub, perm_df2_sub)
}

hist_ttest2 <- function(compare = "ADp40KO_WT", test_gene = "Meg3"){
  perm_df1_sub <- perm_df1[rownames(perm_df1) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df1_sub$exp <- "WT"
  colnames(perm_df1_sub) <- c("gene", "exp")
  
  perm_df2_sub <- perm_df2[rownames(perm_df2) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df2_sub$exp <- "APPPS1"
  colnames(perm_df2_sub) <- c("gene", "exp")
  
  perm_df3_sub <- perm_df3[rownames(perm_df3) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df3_sub$exp <- "APPPS1.il12b-/-"
  colnames(perm_df3_sub) <- c("gene", "exp")
  
  perm_df_sub <- rbind(perm_df2_sub, perm_df3_sub)
}

hist_ttest3 <- function(compare = "ADp40KO_WT", test_gene = "Meg3"){
  perm_df1_sub <- perm_df1[rownames(perm_df1) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df1_sub$exp <- "WT"
  colnames(perm_df1_sub) <- c("gene", "exp")
  
  perm_df2_sub <- perm_df2[rownames(perm_df2) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df2_sub$exp <- "APPPS1"
  colnames(perm_df2_sub) <- c("gene", "exp")
  
  perm_df3_sub <- perm_df3[rownames(perm_df3) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df3_sub$exp <- "APPPS1.il12b-/-"
  colnames(perm_df3_sub) <- c("gene", "exp")
  
  perm_df_sub <- rbind(perm_df1_sub, perm_df3_sub)
}
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
hist_ttest_without_zero <- function(compare = "ADp40KO_WT", test_gene = "Meg3"){
  perm_df1_sub <- perm_df1[rownames(perm_df1) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df1_sub$exp <- "WT"
  colnames(perm_df1_sub) <- c("gene", "exp")
  perm_df1_sub <- perm_df1_sub[perm_df1_sub$gene > 0, ]
  
  perm_df2_sub <- perm_df2[rownames(perm_df2) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df2_sub$exp <- "APPPS1"
  colnames(perm_df2_sub) <- c("gene", "exp")
  perm_df2_sub <- perm_df2_sub[perm_df2_sub$gene > 0, ]
  
  perm_df3_sub <- perm_df3[rownames(perm_df3) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df3_sub$exp <- "APPPS1.il12b-/-"
  colnames(perm_df3_sub) <- c("gene", "exp")
  perm_df3_sub <- perm_df3_sub[perm_df3_sub$gene > 0, ]
  
  perm_df_sub <- rbind(perm_df1_sub, perm_df2_sub)
}

hist_ttest_without_zero2 <- function(compare = "ADp40KO_WT", test_gene = "Meg3"){
  perm_df1_sub <- perm_df1[rownames(perm_df1) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df1_sub$exp <- "WT"
  colnames(perm_df1_sub) <- c("gene", "exp")
  perm_df1_sub <- perm_df1_sub[perm_df1_sub$gene > 0, ]
  
  perm_df2_sub <- perm_df2[rownames(perm_df2) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df2_sub$exp <- "APPPS1"
  colnames(perm_df2_sub) <- c("gene", "exp")
  perm_df2_sub <- perm_df2_sub[perm_df2_sub$gene > 0, ]
  
  perm_df3_sub <- perm_df3[rownames(perm_df3) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df3_sub$exp <- "APPPS1.il12b-/-"
  colnames(perm_df3_sub) <- c("gene", "exp")
  perm_df3_sub <- perm_df3_sub[perm_df3_sub$gene > 0, ]
  
  perm_df_sub <- rbind(perm_df2_sub, perm_df3_sub)
}

hist_ttest_without_zero3 <- function(compare = "ADp40KO_WT", test_gene = "Meg3"){
  perm_df1_sub <- perm_df1[rownames(perm_df1) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df1_sub$exp <- "WT"
  colnames(perm_df1_sub) <- c("gene", "exp")
  perm_df1_sub <- perm_df1_sub[perm_df1_sub$gene > 0, ]
  
  perm_df2_sub <- perm_df2[rownames(perm_df2) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df2_sub$exp <- "APPPS1"
  colnames(perm_df2_sub) <- c("gene", "exp")
  perm_df2_sub <- perm_df2_sub[perm_df2_sub$gene > 0, ]
  
  perm_df3_sub <- perm_df3[rownames(perm_df3) %in% test_gene, ] %>%  t %>% as.data.frame
  perm_df3_sub$exp <- "APPPS1.il12b-/-"
  colnames(perm_df3_sub) <- c("gene", "exp")
  perm_df3_sub <- perm_df3_sub[perm_df3_sub$gene > 0, ]
  
  perm_df_sub <- rbind(perm_df1_sub, perm_df3_sub)
}
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
perm_df1 <- as.data.frame(GetAssayData(data9set_sub_1.SO, slot = "data"))
perm_df2 <- as.data.frame(GetAssayData(data9set_sub_2.SO, slot = "data"))
perm_df3 <- as.data.frame(GetAssayData(data9set_sub_3.SO, slot = "data"))

Meg3_per <- permutation_test(compare = "AD_WT", test_gene = "Gm26520")

g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test2(compare = "AD_ADp40KO", test_gene = "Gm26520")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test3(compare = "ADp40KO_WT", test_gene = "Gm26520")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest(compare = "AD_WT", test_gene = "Gm26520")

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

Meg3_per2 <- hist_ttest2(compare = "AD_ADp40KO", test_gene = "Gm26520")

g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()


Meg3_per3 <- hist_ttest3(compare = "ADp40KO_WT", test_gene = "Gm26520")

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

grid.arrange(g1,g2,g3,ncol =3)
```

Test without zero counts

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}

Meg3_per <- permutation_test_without_zero(compare = "AD_WT", test_gene = "Gm26520")
g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm26520")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm26520")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest_without_zero(compare = "AD_WT", test_gene = "Gm26520")

ttest <- t.test(Meg3_per[Meg3_per$exp %in% "WT", ]$gene , Meg3_per[Meg3_per$exp %in% "APPPS1", ]$gene)

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

Meg3_per2 <- hist_ttest_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm26520")

ttest <- t.test(Meg3_per2[Meg3_per2$exp %in% "APPPS1", ]$gene , Meg3_per2[Meg3_per2$exp %in% "APPPS1.il12b-/-", ]$gene)


g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))


Meg3_per3 <- hist_ttest_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm26520")

ttest <- t.test(Meg3_per3[Meg3_per3$exp %in% "WT", ]$gene , Meg3_per3[Meg3_per3$exp %in% "APPPS1.il12b-/-", ]$gene)

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- permutation_test(compare = "AD_WT", test_gene = "4930479D17Rik")

g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia 4930479D17Rik AD vs WT")

Meg3_per2 <- permutation_test2(compare = "AD_ADp40KO", test_gene = "4930479D17Rik")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia 4930479D17Rik AD vs ADp40KO")

Meg3_per3 <- permutation_test3(compare = "ADp40KO_WT", test_gene = "4930479D17Rik")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia 4930479D17Rik ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest(compare = "AD_WT", test_gene = "4930479D17Rik")

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

Meg3_per2 <- hist_ttest2(compare = "AD_ADp40KO", test_gene = "4930479D17Rik")

g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()


Meg3_per3 <- hist_ttest3(compare = "ADp40KO_WT", test_gene = "4930479D17Rik")

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

grid.arrange(g1,g2,g3,ncol =3)
```

Test without zero counts

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}

Meg3_per <- permutation_test_without_zero(compare = "AD_WT", test_gene = "4930479D17Rik")
g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test_without_zero2(compare = "AD_ADp40KO", test_gene = "4930479D17Rik")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test_without_zero3(compare = "ADp40KO_WT", test_gene = "4930479D17Rik")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest_without_zero(compare = "AD_WT", test_gene = "4930479D17Rik")

ttest <- t.test(Meg3_per[Meg3_per$exp %in% "WT", ]$gene , Meg3_per[Meg3_per$exp %in% "APPPS1", ]$gene)

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

Meg3_per2 <- hist_ttest_without_zero2(compare = "AD_ADp40KO", test_gene = "4930479D17Rik")

ttest <- t.test(Meg3_per2[Meg3_per2$exp %in% "APPPS1", ]$gene , Meg3_per2[Meg3_per2$exp %in% "APPPS1.il12b-/-", ]$gene)


g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))


Meg3_per3 <- hist_ttest_without_zero3(compare = "ADp40KO_WT", test_gene = "4930479D17Rik")

ttest <- t.test(Meg3_per3[Meg3_per3$exp %in% "WT", ]$gene , Meg3_per3[Meg3_per3$exp %in% "APPPS1.il12b-/-", ]$gene)

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- permutation_test(compare = "AD_WT", test_gene = "Gm10790")


g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm10790 AD vs WT")

Meg3_per2 <- permutation_test2(compare = "AD_ADp40KO", test_gene = "Gm10790")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm10790 AD vs ADp40KO")

Meg3_per3 <- permutation_test3(compare = "ADp40KO_WT", test_gene = "Gm10790")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm10790 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest(compare = "AD_WT", test_gene = "Gm10790")

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

Meg3_per2 <- hist_ttest2(compare = "AD_ADp40KO", test_gene = "Gm10790")

g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()


Meg3_per3 <- hist_ttest3(compare = "ADp40KO_WT", test_gene = "Gm10790")

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

grid.arrange(g1,g2,g3,ncol =3)
```

Test without zero counts

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}

Meg3_per <- permutation_test_without_zero(compare = "AD_WT", test_gene = "Gm10790")
g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm10790")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm10790")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest_without_zero(compare = "AD_WT", test_gene = "Gm10790")

ttest <- t.test(Meg3_per[Meg3_per$exp %in% "WT", ]$gene , Meg3_per[Meg3_per$exp %in% "APPPS1", ]$gene)

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

Meg3_per2 <- hist_ttest_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm10790")

ttest <- t.test(Meg3_per2[Meg3_per2$exp %in% "APPPS1", ]$gene , Meg3_per2[Meg3_per2$exp %in% "APPPS1.il12b-/-", ]$gene)


g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))


Meg3_per3 <- hist_ttest_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm10790")

ttest <- t.test(Meg3_per3[Meg3_per3$exp %in% "WT", ]$gene , Meg3_per3[Meg3_per3$exp %in% "APPPS1.il12b-/-", ]$gene)

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

grid.arrange(g1,g2,g3,ncol =3)
```

### 2. Astrocytes

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
AD_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/Astrocytes_AD_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_Ctrl.df2 <- AD_Ctrl.df[AD_Ctrl.df$gene %in% AD_lnc, ]
# select lncRNAs
AD_Ctrl.df <- AD_Ctrl.df[AD_Ctrl.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Astrocytes", ]), ]
# statistical significant
AD_Ctrl.df <- AD_Ctrl.df[which(abs(AD_Ctrl.df$logFC) > 0.25 & AD_Ctrl.df$FDR < 0.05),]


AD_ADp40KO.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/Astrocytes_AD_ADp40KO.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_ADp40KO.df2 <- AD_ADp40KO.df[AD_ADp40KO.df$gene %in% AD_lnc, ]
# select lncRNAs
AD_ADp40KO.df <- AD_ADp40KO.df[AD_ADp40KO.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Astrocytes", ]), ]
# statistical significant
AD_ADp40KO.df <- AD_ADp40KO.df[which(abs(AD_ADp40KO.df$logFC) > 0.25 & AD_ADp40KO.df$FDR < 0.05),]


ADp40KO_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/Astrocytes_ADp40KO_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
ADp40KO_Ctrl.df2 <- ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$gene %in% AD_lnc, ]
# select lncRNAs
ADp40KO_Ctrl.df <- ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Astrocytes", ]), ]
# statistical significant
ADp40KO_Ctrl.df <- ADp40KO_Ctrl.df[which(abs(ADp40KO_Ctrl.df$logFC) > 0.25 & ADp40KO_Ctrl.df$FDR < 0.05),]
 
genes <- c(AD_Ctrl.df[AD_Ctrl.df$logFC > 0, ]$gene, 
           ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$logFC > 0, ]$gene, AD_ADp40KO.df[AD_ADp40KO.df$logFC > 0, ]$gene,
           AD_ADp40KO.df[AD_ADp40KO.df$logFC < 0, ]$gene, 
           ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$logFC < 0, ]$gene, AD_Ctrl.df[AD_Ctrl.df$logFC < 0, ]$gene) %>% unique

genes <- factor(genes, levels = genes)
```

AD vs WT

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_Ctrl.df2[,c(6:11)])
```

AD vs ADp40KO

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_ADp40KO.df2[,c(6:11)])
```

ADp40KO vs WT

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(ADp40KO_Ctrl.df2[,c(6:11)])
```

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
data9set_cleaned.SO$cell_type <- data9set_cleaned.SO@active.ident
#table(data9set_cleaned.SO$cell_type)

data9set_sub.SO <- subset(data9set_cleaned.SO, subset = cell_type %in% c("Astrocytes"))

##########################
# z-score for each sample
##########################
data9set_sub_1.SO <- subset(data9set_sub.SO, subset = sample %in% "Ctrl")
data9set_sub_2.SO <- subset(data9set_sub.SO, subset = sample %in% "AD")
data9set_sub_3.SO <- subset(data9set_sub.SO, subset = sample %in% "ADp40KO")

########################
# expression calculation
########################
df1 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_1.SO, slot = "data")))
df1$gene <- rownames(df1)
colnames(df1) <- c("WT", "gene")

df2 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_2.SO, slot = "data")))
df2$gene <- rownames(df2)
colnames(df2) <- c("APPPS1", "gene")

df3 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_3.SO, slot = "data")))
df3$gene <- rownames(df3)
colnames(df3) <- c("APPPS1.il12b-/-", "gene")

df <- merge(df1, c(df2, df3))
df$gene.1 <- NULL

ZS.df1 <- z_score_from_gene_list(data9set_sub_1.SO, genes)
colnames(ZS.df1) <- c("WT", "gene")
ZS.df2 <- z_score_from_gene_list(data9set_sub_2.SO, genes)
colnames(ZS.df2) <- c("APPPS1", "gene")
ZS.df3 <- z_score_from_gene_list(data9set_sub_3.SO, genes)
colnames(ZS.df3) <- c("APPPS1.il12b-/-", "gene")

# merge all data frame
ZS.df <- merge(ZS.df1, c(ZS.df2, ZS.df3), by = "gene")

ZS.df$gene.1 <- NULL
rownames(ZS.df) <- ZS.df$gene
ZS.df$gene <- NULL

sub_ZS.df <- apply(ZS.df, 1, function(x) (x - mean(x)) / sd(x))
sub_ZS.df <- data.frame(t(sub_ZS.df))
sub_ZS.df$gene <- rownames(sub_ZS.df)

sub_ZS.df <- gather(sub_ZS.df, sample, z_score, "WT":"APPPS1.il12b...")

sub_zs.df2 <- left_join(sub_ZS.df, df, by = "gene")

sub_zs.df2$gene <- factor(sub_zs.df2$gene, levels = genes)

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
ZS.df1 <- z_score_from_gene_list(data9set_sub_1.SO, AD_lnc)
colnames(ZS.df1) <- c("WT", "gene")
ZS.df2 <- z_score_from_gene_list(data9set_sub_2.SO, AD_lnc)
colnames(ZS.df2) <- c("APPPS1", "gene")
ZS.df3 <- z_score_from_gene_list(data9set_sub_3.SO, AD_lnc)
colnames(ZS.df3) <- c("APPPS1.il12b-/-", "gene")

# merge all data frame
ZS.df <- merge(ZS.df1, c(ZS.df2, ZS.df3), by = "gene")

ZS.df$gene.1 <- NULL
rownames(ZS.df) <- ZS.df$gene
ZS.df$gene <- NULL

sub_ZS.df <- apply(ZS.df, 1, function(x) (x - mean(x)) / sd(x))
sub_ZS.df <- data.frame(t(sub_ZS.df))
sub_ZS.df$gene <- rownames(sub_ZS.df)

sub_ZS.df <- gather(sub_ZS.df, sample, z_score, "WT":"APPPS1.il12b...")

sub_zs.df2 <- left_join(sub_ZS.df, df, by = "gene")

sub_zs.df2$gene <- factor(sub_zs.df2$gene, levels = AD_lnc)

sub_zs.df2$cell_type <- "Astrocytes"

AD_lnc_AS <- sub_zs.df2

```


```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
g1 <- ggplot(data = sub_zs.df2, mapping = aes(x = sample, y = gene, fill = z_score)) +
  geom_tile() + scale_y_discrete(position = "right")  + coord_flip() +  theme_classic() + theme(plot.title = element_text(size = 15, hjust = 0.5), 
                                        axis.title.y = element_blank(),
                                         axis.title.x = element_blank(),
                                         axis.text.x.top = element_text(angle = 90, vjust = 0.5, size = 12, color = "black"),
                                         axis.text.y = element_text(size = 12, color = "black"),
                                         axis.line = element_line(color = "white"),
                                         axis.ticks = element_line(color = "white"),
                                         legend.title = element_text(size = 11, color = "white"),
                                         legend.text = element_text(size = 11, color = "black"),
                                         panel.spacing = unit(0, "mm"), 
                                        panel.margin= unit(c(-1.1), "mm"), 
                                        plot.margin = margin(0, 0, 0, 0, "cm"),
                                        strip.background = element_blank(),
                                        strip.text.x = element_text(size = .2, color = "white")) + 
  #scale_fill_gradient2(low="red", high='blue', mid="white", midpoint = 0) +  
  #scale_fill_gradientn("expression", colours = c("#003366", "#FFCC66", "#990000"), limits = c(-1.5, 1.5), oob=squish)
  scale_fill_viridis_c("expression", limits=c(-1.5, 1.5), na.value = "#FDE725FF", labels = c("-1.5", "-1.0", "-0.5","0","0.5","1.0", "1.5"), oob=squish)

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
sub_zs.df3 <- sub_zs.df2[,c(1:2, 4:6)]

sub_zs.df3 <- gather(sub_zs.df3, sample, expression, "WT":"APPPS1.il12b...")

g2 <- ggplot(data = sub_zs.df3, mapping = aes(x = sample, y = gene, fill = expression)) +
  geom_tile() + scale_y_discrete(position = "right")  + coord_flip() +  theme_classic() +
  theme(plot.title = element_text(size = 15, hjust = 0.5), 
                                        axis.title.y = element_blank(),
                                         axis.title.x = element_blank(),
                                         axis.text.x = element_blank(),
                                         axis.text.y = element_text(size = 12, color = "black"),
                                         axis.line = element_line(color = "white"),
                                         axis.ticks = element_line(color = "white"),
                                         legend.title = element_text(size = 11, color = "black"),
                                         legend.text = element_text(size = 11, color = "black"),
                                         panel.spacing = unit(0, "mm"), 
                                        panel.margin= unit(c(-1.1), "mm"), 
                                        plot.margin = margin(0, 0, 0, 0, "cm"),
                                        strip.background = element_blank(),
                                        strip.text.x = element_text(size = 10, color = "black")) + 
  #scale_fill_gradient2(low="red", high='blue', mid="white", midpoint = 0) +  
  scale_fill_gradientn("expression", colours = c("#003366", "#FFCC66", "#990000"), limits = c(0, 3), oob=squish)



grid.arrange(g1, g2, ncol = 1, heights=c(5,2))
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
perm_df1 <- as.data.frame(GetAssayData(data9set_sub_1.SO, slot = "data"))
perm_df2 <- as.data.frame(GetAssayData(data9set_sub_2.SO, slot = "data"))
perm_df3 <- as.data.frame(GetAssayData(data9set_sub_3.SO, slot = "data"))


Meg3_per <- permutation_test(compare = "AD_WT", test_gene = "Rmst")


g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Astrocytes Rmst AD vs WT")

Meg3_per2 <- permutation_test2(compare = "AD_ADp40KO", test_gene = "Rmst")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Astrocytes Rmst AD vs ADp40KO")

Meg3_per3 <- permutation_test3(compare = "ADp40KO_WT", test_gene = "Rmst")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Astrocytes Rmst ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest(compare = "AD_WT", test_gene = "Rmst")

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

Meg3_per2 <- hist_ttest2(compare = "AD_ADp40KO", test_gene = "Rmst")

g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()


Meg3_per3 <- hist_ttest3(compare = "ADp40KO_WT", test_gene = "Rmst")

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

grid.arrange(g1,g2,g3,ncol =3)
```

Test without zero counts

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}

Meg3_per <- permutation_test_without_zero(compare = "AD_WT", test_gene = "Rmst")
g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test_without_zero2(compare = "AD_ADp40KO", test_gene = "Rmst")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test_without_zero3(compare = "ADp40KO_WT", test_gene = "Rmst")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest_without_zero(compare = "AD_WT", test_gene = "Rmst")

ttest <- t.test(Meg3_per[Meg3_per$exp %in% "WT", ]$gene , Meg3_per[Meg3_per$exp %in% "APPPS1", ]$gene)

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

Meg3_per2 <- hist_ttest_without_zero2(compare = "AD_ADp40KO", test_gene = "Rmst")

ttest <- t.test(Meg3_per2[Meg3_per2$exp %in% "APPPS1", ]$gene , Meg3_per2[Meg3_per2$exp %in% "APPPS1.il12b-/-", ]$gene)


g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))


Meg3_per3 <- hist_ttest_without_zero3(compare = "ADp40KO_WT", test_gene = "Rmst")

ttest <- t.test(Meg3_per3[Meg3_per3$exp %in% "WT", ]$gene , Meg3_per3[Meg3_per3$exp %in% "APPPS1.il12b-/-", ]$gene)

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- permutation_test(compare = "AD_WT", test_gene = "Gm20743")

g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Astrocytes Gm20743 AD vs WT")

Meg3_per2 <- permutation_test2(compare = "AD_ADp40KO", test_gene = "Gm20743")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Astrocytes Gm20743 AD vs ADp40KO")

Meg3_per3 <- permutation_test3(compare = "ADp40KO_WT", test_gene = "Gm20743")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Astrocytes Gm20743 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest(compare = "AD_WT", test_gene = "Gm20743")

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

Meg3_per2 <- hist_ttest2(compare = "AD_ADp40KO", test_gene = "Gm20743")

g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()


Meg3_per3 <- hist_ttest3(compare = "ADp40KO_WT", test_gene = "Gm20743")

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

grid.arrange(g1,g2,g3,ncol =3)
```

Test without zero counts

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}

Meg3_per <- permutation_test_without_zero(compare = "AD_WT", test_gene = "Gm20743")
g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm20743")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm20743")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest_without_zero(compare = "AD_WT", test_gene = "Gm20743")

ttest <- t.test(Meg3_per[Meg3_per$exp %in% "WT", ]$gene , Meg3_per[Meg3_per$exp %in% "APPPS1", ]$gene)

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

Meg3_per2 <- hist_ttest_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm20743")

ttest <- t.test(Meg3_per2[Meg3_per2$exp %in% "APPPS1", ]$gene , Meg3_per2[Meg3_per2$exp %in% "APPPS1.il12b-/-", ]$gene)


g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))


Meg3_per3 <- hist_ttest_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm20743")

ttest <- t.test(Meg3_per3[Meg3_per3$exp %in% "WT", ]$gene , Meg3_per3[Meg3_per3$exp %in% "APPPS1.il12b-/-", ]$gene)

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

grid.arrange(g1,g2,g3,ncol =3)
```

### 3. Oligodendrocytes

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
AD_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/MOL_AD_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_Ctrl.df2 <- AD_Ctrl.df[AD_Ctrl.df$gene %in% AD_lnc, ]
# select lncRNAs
AD_Ctrl.df <- AD_Ctrl.df[AD_Ctrl.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Oligo", ]), ]
# statistical significant
AD_Ctrl.df <- AD_Ctrl.df[which(abs(AD_Ctrl.df$logFC) > 0.25 & AD_Ctrl.df$FDR < 0.05),]


AD_ADp40KO.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/MOL_AD_ADp40KO.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_ADp40KO.df2 <- AD_ADp40KO.df[AD_ADp40KO.df$gene %in% AD_lnc, ]
# select lncRNAs
AD_ADp40KO.df <- AD_ADp40KO.df[AD_ADp40KO.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Oligo", ]), ]
# statistical significant
AD_ADp40KO.df <- AD_ADp40KO.df[which(abs(AD_ADp40KO.df$logFC) > 0.25 & AD_ADp40KO.df$FDR < 0.05),]


ADp40KO_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/MOL_ADp40KO_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
ADp40KO_Ctrl.df2 <- ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$gene %in% AD_lnc, ]
# select lncRNAs
ADp40KO_Ctrl.df <- ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Oligo", ]), ]
# statistical significant
ADp40KO_Ctrl.df <- ADp40KO_Ctrl.df[which(abs(ADp40KO_Ctrl.df$logFC) > 0.25 & ADp40KO_Ctrl.df$FDR < 0.05),]
 
genes <- c(AD_Ctrl.df[AD_Ctrl.df$logFC > 0, ]$gene, 
           ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$logFC > 0, ]$gene, AD_ADp40KO.df[AD_ADp40KO.df$logFC > 0, ]$gene,
           AD_ADp40KO.df[AD_ADp40KO.df$logFC < 0, ]$gene, 
           ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$logFC < 0, ]$gene, AD_Ctrl.df[AD_Ctrl.df$logFC < 0, ]$gene) %>% unique

```

AD vs WT (MOL)

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_Ctrl.df2[,c(6:11)])
```

AD vs ADp40KO (MOL)

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_ADp40KO.df2[,c(6:11)])
```

ADp40KO vs WT (MOL)

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(ADp40KO_Ctrl.df2[,c(6:11)])
```

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
AD_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/MFOL_AD_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)

AD_ADp40KO.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/MFOL_AD_ADp40KO.csv", row.names = 1, stringsAsFactors = FALSE)

ADp40KO_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/MFOL_ADp40KO_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
```

AD vs WT (MFOL)

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_Ctrl.df2[,c(6:11)])
```

AD vs ADp40KO (MFOL)

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_ADp40KO.df2[,c(6:11)])
```

ADp40KO vs WT (MFOL)

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(ADp40KO_Ctrl.df2[,c(6:11)])
```

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
data9set_cleaned.SO$cell_type <- data9set_cleaned.SO@active.ident
#table(data9set_cleaned.SO$cell_type)

data9set_sub.SO <- subset(data9set_cleaned.SO, subset = cell_type %in% c("Oligo"))

##########################
# z-score for each sample
##########################
data9set_sub_1.SO <- subset(data9set_sub.SO, subset = sample %in% "Ctrl")
data9set_sub_2.SO <- subset(data9set_sub.SO, subset = sample %in% "AD")
data9set_sub_3.SO <- subset(data9set_sub.SO, subset = sample %in% "ADp40KO")

########################
# expression calculation
########################
df1 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_1.SO, slot = "data")))
df1$gene <- rownames(df1)
colnames(df1) <- c("WT", "gene")

df2 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_2.SO, slot = "data")))
df2$gene <- rownames(df2)
colnames(df2) <- c("APPPS1", "gene")

df3 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_3.SO, slot = "data")))
df3$gene <- rownames(df3)
colnames(df3) <- c("APPPS1.il12b-/-", "gene")

df <- merge(df1, c(df2, df3))
df$gene.1 <- NULL

ZS.df1 <- z_score_from_gene_list(data9set_sub_1.SO, genes)
colnames(ZS.df1) <- c("WT", "gene")
ZS.df2 <- z_score_from_gene_list(data9set_sub_2.SO, genes)
colnames(ZS.df2) <- c("APPPS1", "gene")
ZS.df3 <- z_score_from_gene_list(data9set_sub_3.SO, genes)
colnames(ZS.df3) <- c("APPPS1.il12b-/-", "gene")

# merge all data frame
ZS.df <- merge(ZS.df1, c(ZS.df2, ZS.df3), by = "gene")

ZS.df$gene.1 <- NULL
rownames(ZS.df) <- ZS.df$gene
ZS.df$gene <- NULL

sub_ZS.df <- apply(ZS.df, 1, function(x) (x - mean(x)) / sd(x))
sub_ZS.df <- data.frame(t(sub_ZS.df))
sub_ZS.df$gene <- rownames(sub_ZS.df)

sub_ZS.df <- gather(sub_ZS.df, sample, z_score, "WT":"APPPS1.il12b...")

sub_zs.df2 <- left_join(sub_ZS.df, df, by = "gene")

sub_zs.df2$gene <- factor(sub_zs.df2$gene, levels = genes)

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
ZS.df1 <- z_score_from_gene_list(data9set_sub_1.SO, AD_lnc)
colnames(ZS.df1) <- c("WT", "gene")
ZS.df2 <- z_score_from_gene_list(data9set_sub_2.SO, AD_lnc)
colnames(ZS.df2) <- c("APPPS1", "gene")
ZS.df3 <- z_score_from_gene_list(data9set_sub_3.SO, AD_lnc)
colnames(ZS.df3) <- c("APPPS1.il12b-/-", "gene")

# merge all data frame
ZS.df <- merge(ZS.df1, c(ZS.df2, ZS.df3), by = "gene")

ZS.df$gene.1 <- NULL
rownames(ZS.df) <- ZS.df$gene
ZS.df$gene <- NULL

sub_ZS.df <- apply(ZS.df, 1, function(x) (x - mean(x)) / sd(x))
sub_ZS.df <- data.frame(t(sub_ZS.df))
sub_ZS.df$gene <- rownames(sub_ZS.df)

sub_ZS.df <- gather(sub_ZS.df, sample, z_score, "WT":"APPPS1.il12b...")

sub_zs.df2 <- left_join(sub_ZS.df, df, by = "gene")

sub_zs.df2$gene <- factor(sub_zs.df2$gene, levels = AD_lnc)

sub_zs.df2$cell_type <- "Oligo"

AD_lnc_OL <- sub_zs.df2

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
g1 <- ggplot(data = sub_zs.df2, mapping = aes(x = sample, y = gene, fill = z_score)) +
  geom_tile() + scale_y_discrete(position = "right")  + coord_flip() +  theme_classic() + theme(plot.title = element_text(size = 15, hjust = 0.5), 
                                        axis.title.y = element_blank(),
                                         axis.title.x = element_blank(),
                                         axis.text.x.top = element_text(angle = 90, vjust = 0.5, size = 12, color = "black"),
                                         axis.text.y = element_text(size = 12, color = "black"),
                                         axis.line = element_line(color = "white"),
                                         axis.ticks = element_line(color = "white"),
                                         legend.title = element_text(size = 11, color = "white"),
                                         legend.text = element_text(size = 11, color = "black"),
                                         panel.spacing = unit(0, "mm"), 
                                        panel.margin= unit(c(-1.1), "mm"), 
                                        plot.margin = margin(0, 0, 0, 0, "cm"),
                                        strip.background = element_blank(),
                                        strip.text.x = element_text(size = .2, color = "white")) + 
  #scale_fill_gradient2(low="red", high='blue', mid="white", midpoint = 0) +  
  #scale_fill_gradientn("expression", colours = c("#003366", "#FFCC66", "#990000"), limits = c(-1.5, 1.5), oob=squish)
  scale_fill_viridis_c("expression", limits=c(-1.5, 1.5), na.value = "#FDE725FF", labels = c("-1.5", "-1.0", "-0.5","0","0.5","1.0", "1.5"), oob=squish)

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
sub_zs.df3 <- sub_zs.df2[,c(1:2, 4:6)]

sub_zs.df3 <- gather(sub_zs.df3, sample, expression, "WT":"APPPS1.il12b...")

g2 <- ggplot(data = sub_zs.df3, mapping = aes(x = sample, y = gene, fill = expression)) +
  geom_tile() + scale_y_discrete(position = "right")  + coord_flip() +  theme_classic() +
  theme(plot.title = element_text(size = 15, hjust = 0.5), 
                                        axis.title.y = element_blank(),
                                         axis.title.x = element_blank(),
                                         axis.text.x = element_blank(),
                                         axis.text.y = element_text(size = 12, color = "black"),
                                         axis.line = element_line(color = "white"),
                                         axis.ticks = element_line(color = "white"),
                                         legend.title = element_text(size = 11, color = "black"),
                                         legend.text = element_text(size = 11, color = "black"),
                                         panel.spacing = unit(0, "mm"), 
                                        panel.margin= unit(c(-1.1), "mm"), 
                                        plot.margin = margin(0, 0, 0, 0, "cm"),
                                        strip.background = element_blank(),
                                        strip.text.x = element_text(size = 10, color = "black")) + 
  #scale_fill_gradient2(low="red", high='blue', mid="white", midpoint = 0) +  
  scale_fill_gradientn("expression", colours = c("#003366", "#FFCC66", "#990000"), limits = c(0, 3), oob=squish)



grid.arrange(g1, g2, ncol = 1, heights=c(5,2))
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
perm_df1 <- as.data.frame(GetAssayData(data9set_sub_1.SO, slot = "data"))
perm_df2 <- as.data.frame(GetAssayData(data9set_sub_2.SO, slot = "data"))
perm_df3 <- as.data.frame(GetAssayData(data9set_sub_3.SO, slot = "data"))


Meg3_per <- permutation_test(compare = "AD_WT", test_gene = "Gm50323")


g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Oligo Gm50323 AD vs WT")

Meg3_per2 <- permutation_test2(compare = "AD_ADp40KO", test_gene = "Gm50323")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Oligo Gm50323 AD vs ADp40KO")

Meg3_per3 <- permutation_test3(compare = "ADp40KO_WT", test_gene = "Gm50323")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Oligo Gm50323 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest(compare = "AD_WT", test_gene = "Gm50323")

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

Meg3_per2 <- hist_ttest2(compare = "AD_ADp40KO", test_gene = "Gm50323")

g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()


Meg3_per3 <- hist_ttest3(compare = "ADp40KO_WT", test_gene = "Gm50323")

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

grid.arrange(g1,g2,g3,ncol =3)
```

Test without zero counts

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}

Meg3_per <- permutation_test_without_zero(compare = "AD_WT", test_gene = "Gm50323")
g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm50323")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm50323")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest_without_zero(compare = "AD_WT", test_gene = "Gm50323")

ttest <- t.test(Meg3_per[Meg3_per$exp %in% "WT", ]$gene , Meg3_per[Meg3_per$exp %in% "APPPS1", ]$gene)

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

Meg3_per2 <- hist_ttest_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm50323")

ttest <- t.test(Meg3_per2[Meg3_per2$exp %in% "APPPS1", ]$gene , Meg3_per2[Meg3_per2$exp %in% "APPPS1.il12b-/-", ]$gene)


g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))


Meg3_per3 <- hist_ttest_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm50323")

ttest <- t.test(Meg3_per3[Meg3_per3$exp %in% "WT", ]$gene , Meg3_per3[Meg3_per3$exp %in% "APPPS1.il12b-/-", ]$gene)

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- permutation_test(compare = "AD_WT", test_gene = "Gm44866")


g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Oligo Gm44866 AD vs WT")

Meg3_per2 <- permutation_test2(compare = "AD_ADp40KO", test_gene = "Gm44866")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Oligo Gm44866 AD vs ADp40KO")

Meg3_per3 <- permutation_test3(compare = "ADp40KO_WT", test_gene = "Gm44866")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Oligo Gm44866 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest(compare = "AD_WT", test_gene = "Gm44866")

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

Meg3_per2 <- hist_ttest2(compare = "AD_ADp40KO", test_gene = "Gm44866")

g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()


Meg3_per3 <- hist_ttest3(compare = "ADp40KO_WT", test_gene = "Gm44866")

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

grid.arrange(g1,g2,g3,ncol =3)
```

Test without zero counts

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}

Meg3_per <- permutation_test_without_zero(compare = "AD_WT", test_gene = "Gm44866")
g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm44866")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm44866")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest_without_zero(compare = "AD_WT", test_gene = "Gm44866")

ttest <- t.test(Meg3_per[Meg3_per$exp %in% "WT", ]$gene , Meg3_per[Meg3_per$exp %in% "APPPS1", ]$gene)

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

Meg3_per2 <- hist_ttest_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm44866")

ttest <- t.test(Meg3_per2[Meg3_per2$exp %in% "APPPS1", ]$gene , Meg3_per2[Meg3_per2$exp %in% "APPPS1.il12b-/-", ]$gene)


g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))


Meg3_per3 <- hist_ttest_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm44866")

ttest <- t.test(Meg3_per3[Meg3_per3$exp %in% "WT", ]$gene , Meg3_per3[Meg3_per3$exp %in% "APPPS1.il12b-/-", ]$gene)

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

grid.arrange(g1,g2,g3,ncol =3)
```

### 4. OPC

None of specific OPC & DE lncRNA exist but check AD related lncRNAs

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
AD_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/OPC_AD_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_Ctrl.df2 <- AD_Ctrl.df[AD_Ctrl.df$gene %in% AD_lnc, ]

AD_ADp40KO.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/OPC_AD_ADp40KO.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_ADp40KO.df2 <- AD_ADp40KO.df[AD_ADp40KO.df$gene %in% AD_lnc, ]


ADp40KO_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/OPC_ADp40KO_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
ADp40KO_Ctrl.df2 <- ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$gene %in% AD_lnc, ]

```

AD vs WT

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_Ctrl.df2[,c(6:11)])
```

AD vs ADp40KO

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_ADp40KO.df2[,c(6:11)])
```

ADp40KO vs WT

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(ADp40KO_Ctrl.df2[,c(6:11)])
```

### 5. IN

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
AD_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/Inhibitory_Neurons_AD_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_Ctrl.df2 <- AD_Ctrl.df[AD_Ctrl.df$gene %in% AD_lnc, ]
# select lncRNAs
AD_Ctrl.df <- AD_Ctrl.df[AD_Ctrl.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Inhibitory", ]), ]
# statistical significant
AD_Ctrl.df <- AD_Ctrl.df[which(abs(AD_Ctrl.df$logFC) > 0.25 & AD_Ctrl.df$FDR < 0.05),]


AD_ADp40KO.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/Inhibitory_Neurons_AD_ADp40KO.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_ADp40KO.df2 <- AD_ADp40KO.df[AD_ADp40KO.df$gene %in% AD_lnc, ]
# select lncRNAs
AD_ADp40KO.df <- AD_ADp40KO.df[AD_ADp40KO.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Inhibitory", ]), ]
# statistical significant
AD_ADp40KO.df <- AD_ADp40KO.df[which(abs(AD_ADp40KO.df$logFC) > 0.25 & AD_ADp40KO.df$FDR < 0.05),]


ADp40KO_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/Inhibitory_Neurons_ADp40KO_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
ADp40KO_Ctrl.df2 <- ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$gene %in% AD_lnc, ]
# select lncRNAs
ADp40KO_Ctrl.df <- ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Inhibitory", ]), ]
# statistical significant
ADp40KO_Ctrl.df <- ADp40KO_Ctrl.df[which(abs(ADp40KO_Ctrl.df$logFC) > 0.25 & ADp40KO_Ctrl.df$FDR < 0.05),]
 
genes <- c(AD_Ctrl.df[AD_Ctrl.df$logFC > 0, ]$gene, 
           ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$logFC > 0, ]$gene, AD_ADp40KO.df[AD_ADp40KO.df$logFC > 0, ]$gene,
           AD_ADp40KO.df[AD_ADp40KO.df$logFC < 0, ]$gene, 
           ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$logFC < 0, ]$gene, AD_Ctrl.df[AD_Ctrl.df$logFC < 0, ]$gene) %>% unique

```

AD vs WT

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_Ctrl.df2[,c(6:11)])
```

AD vs ADp40KO

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_ADp40KO.df2[,c(6:11)])
```

ADp40KO vs WT

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(ADp40KO_Ctrl.df2[,c(6:11)])
```

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
data9set_cleaned.SO$cell_type <- data9set_cleaned.SO@active.ident
#table(data9set_cleaned.SO$cell_type)

data9set_sub.SO <- subset(data9set_cleaned.SO, subset = cell_type %in% c("Inhibitory Interneurons"))

##########################
# z-score for each sample
##########################
data9set_sub_1.SO <- subset(data9set_sub.SO, subset = sample %in% "Ctrl")
data9set_sub_2.SO <- subset(data9set_sub.SO, subset = sample %in% "AD")
data9set_sub_3.SO <- subset(data9set_sub.SO, subset = sample %in% "ADp40KO")

########################
# expression calculation
########################
df1 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_1.SO, slot = "data")))
df1$gene <- rownames(df1)
colnames(df1) <- c("WT", "gene")

df2 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_2.SO, slot = "data")))
df2$gene <- rownames(df2)
colnames(df2) <- c("APPPS1", "gene")

df3 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_3.SO, slot = "data")))
df3$gene <- rownames(df3)
colnames(df3) <- c("APPPS1.il12b-/-", "gene")

df <- merge(df1, c(df2, df3))
df$gene.1 <- NULL

ZS.df1 <- z_score_from_gene_list(data9set_sub_1.SO, genes)
colnames(ZS.df1) <- c("WT", "gene")
ZS.df2 <- z_score_from_gene_list(data9set_sub_2.SO, genes)
colnames(ZS.df2) <- c("APPPS1", "gene")
ZS.df3 <- z_score_from_gene_list(data9set_sub_3.SO, genes)
colnames(ZS.df3) <- c("APPPS1.il12b-/-", "gene")

# merge all data frame
ZS.df <- merge(ZS.df1, c(ZS.df2, ZS.df3), by = "gene")

ZS.df$gene.1 <- NULL
rownames(ZS.df) <- ZS.df$gene
ZS.df$gene <- NULL

sub_ZS.df <- apply(ZS.df, 1, function(x) (x - mean(x)) / sd(x))
sub_ZS.df <- data.frame(t(sub_ZS.df))
sub_ZS.df$gene <- rownames(sub_ZS.df)

sub_ZS.df <- gather(sub_ZS.df, sample, z_score, "WT":"APPPS1.il12b...")

sub_zs.df2 <- left_join(sub_ZS.df, df, by = "gene")

sub_zs.df2$gene <- factor(sub_zs.df2$gene, levels = genes)

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
ZS.df1 <- z_score_from_gene_list(data9set_sub_1.SO, AD_lnc)
colnames(ZS.df1) <- c("WT", "gene")
ZS.df2 <- z_score_from_gene_list(data9set_sub_2.SO, AD_lnc)
colnames(ZS.df2) <- c("APPPS1", "gene")
ZS.df3 <- z_score_from_gene_list(data9set_sub_3.SO, AD_lnc)
colnames(ZS.df3) <- c("APPPS1.il12b-/-", "gene")

# merge all data frame
ZS.df <- merge(ZS.df1, c(ZS.df2, ZS.df3), by = "gene")

ZS.df$gene.1 <- NULL
rownames(ZS.df) <- ZS.df$gene
ZS.df$gene <- NULL

sub_ZS.df <- apply(ZS.df, 1, function(x) (x - mean(x)) / sd(x))
sub_ZS.df <- data.frame(t(sub_ZS.df))
sub_ZS.df$gene <- rownames(sub_ZS.df)

sub_ZS.df <- gather(sub_ZS.df, sample, z_score, "WT":"APPPS1.il12b...")

sub_zs.df2 <- left_join(sub_ZS.df, df, by = "gene")

sub_zs.df2$gene <- factor(sub_zs.df2$gene, levels = AD_lnc)

sub_zs.df2$cell_type <- "Inhibitory"

AD_lnc_IN <- sub_zs.df2

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
g1 <- ggplot(data = sub_zs.df2, mapping = aes(x = sample, y = gene, fill = z_score)) +
  geom_tile() + scale_y_discrete(position = "right")  + coord_flip() +  theme_classic() + theme(plot.title = element_text(size = 15, hjust = 0.5), 
                                        axis.title.y = element_blank(),
                                         axis.title.x = element_blank(),
                                         axis.text.x.top = element_text(angle = 90, vjust = 0.5, size = 12, color = "black"),
                                         axis.text.y = element_text(size = 12, color = "black"),
                                         axis.line = element_line(color = "white"),
                                         axis.ticks = element_line(color = "white"),
                                         legend.title = element_text(size = 11, color = "white"),
                                         legend.text = element_text(size = 11, color = "black"),
                                         panel.spacing = unit(0, "mm"), 
                                        panel.margin= unit(c(-1.1), "mm"), 
                                        plot.margin = margin(0, 0, 0, 0, "cm"),
                                        strip.background = element_blank(),
                                        strip.text.x = element_text(size = .2, color = "white")) + 
  #scale_fill_gradient2(low="red", high='blue', mid="white", midpoint = 0) +  
  #scale_fill_gradientn("expression", colours = c("#003366", "#FFCC66", "#990000"), limits = c(-1.5, 1.5), oob=squish)
  scale_fill_viridis_c("expression", limits=c(-1.5, 1.5), na.value = "#FDE725FF", labels = c("-1.5", "-1.0", "-0.5","0","0.5","1.0", "1.5"), oob=squish)

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
sub_zs.df3 <- sub_zs.df2[,c(1:2, 4:6)]

sub_zs.df3 <- gather(sub_zs.df3, sample, expression, "WT":"APPPS1.il12b...")

g2 <- ggplot(data = sub_zs.df3, mapping = aes(x = sample, y = gene, fill = expression)) +
  geom_tile() + scale_y_discrete(position = "right")  + coord_flip() +  theme_classic() +
  theme(plot.title = element_text(size = 15, hjust = 0.5), 
                                        axis.title.y = element_blank(),
                                         axis.title.x = element_blank(),
                                         axis.text.x = element_blank(),
                                         axis.text.y = element_text(size = 12, color = "black"),
                                         axis.line = element_line(color = "white"),
                                         axis.ticks = element_line(color = "white"),
                                         legend.title = element_text(size = 11, color = "black"),
                                         legend.text = element_text(size = 11, color = "black"),
                                         panel.spacing = unit(0, "mm"), 
                                        panel.margin= unit(c(-1.1), "mm"), 
                                        plot.margin = margin(0, 0, 0, 0, "cm"),
                                        strip.background = element_blank(),
                                        strip.text.x = element_text(size = 10, color = "black")) + 
  #scale_fill_gradient2(low="red", high='blue', mid="white", midpoint = 0) +  
  scale_fill_gradientn("expression", colours = c("#003366", "#FFCC66", "#990000"), limits = c(0, 3), oob=squish)



grid.arrange(g1, g2, ncol = 1, heights=c(5,2))
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
perm_df1 <- as.data.frame(GetAssayData(data9set_sub_1.SO, slot = "data"))
perm_df2 <- as.data.frame(GetAssayData(data9set_sub_2.SO, slot = "data"))
perm_df3 <- as.data.frame(GetAssayData(data9set_sub_3.SO, slot = "data"))


Meg3_per <- permutation_test(compare = "AD_WT", test_gene = "Lrp8os3")


g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Inhibitory Lrp8os3 AD vs WT")

Meg3_per2 <- permutation_test2(compare = "AD_ADp40KO", test_gene = "Lrp8os3")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Inhibitory Lrp8os3 AD vs ADp40KO")

Meg3_per3 <- permutation_test3(compare = "ADp40KO_WT", test_gene = "Lrp8os3")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Inhibitory Lrp8os3 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest(compare = "AD_WT", test_gene = "Lrp8os3")

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

Meg3_per2 <- hist_ttest2(compare = "AD_ADp40KO", test_gene = "Lrp8os3")

g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()


Meg3_per3 <- hist_ttest3(compare = "ADp40KO_WT", test_gene = "Lrp8os3")

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

grid.arrange(g1,g2,g3,ncol =3)
```

Test without zero counts

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}

Meg3_per <- permutation_test_without_zero(compare = "AD_WT", test_gene = "Lrp8os3")
g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test_without_zero2(compare = "AD_ADp40KO", test_gene = "Lrp8os3")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test_without_zero3(compare = "ADp40KO_WT", test_gene = "Lrp8os3")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest_without_zero(compare = "AD_WT", test_gene = "Lrp8os3")

ttest <- t.test(Meg3_per[Meg3_per$exp %in% "WT", ]$gene , Meg3_per[Meg3_per$exp %in% "APPPS1", ]$gene)

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

Meg3_per2 <- hist_ttest_without_zero2(compare = "AD_ADp40KO", test_gene = "Lrp8os3")

ttest <- t.test(Meg3_per2[Meg3_per2$exp %in% "APPPS1", ]$gene , Meg3_per2[Meg3_per2$exp %in% "APPPS1.il12b-/-", ]$gene)


g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))


Meg3_per3 <- hist_ttest_without_zero3(compare = "ADp40KO_WT", test_gene = "Lrp8os3")

ttest <- t.test(Meg3_per3[Meg3_per3$exp %in% "WT", ]$gene , Meg3_per3[Meg3_per3$exp %in% "APPPS1.il12b-/-", ]$gene)

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- permutation_test(compare = "AD_WT", test_gene = "C130073E24Rik")


g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Inhibitory C130073E24Rik AD vs WT")

Meg3_per2 <- permutation_test2(compare = "AD_ADp40KO", test_gene = "C130073E24Rik")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Inhibitory C130073E24Rik AD vs ADp40KO")

Meg3_per3 <- permutation_test3(compare = "ADp40KO_WT", test_gene = "C130073E24Rik")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Inhibitory C130073E24Rik ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest(compare = "AD_WT", test_gene = "C130073E24Rik")

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

Meg3_per2 <- hist_ttest2(compare = "AD_ADp40KO", test_gene = "C130073E24Rik")

g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()


Meg3_per3 <- hist_ttest3(compare = "ADp40KO_WT", test_gene = "C130073E24Rik")

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

grid.arrange(g1,g2,g3,ncol =3)
```

Test without zero counts

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}

Meg3_per <- permutation_test_without_zero(compare = "AD_WT", test_gene = "C130073E24Rik")
g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test_without_zero2(compare = "AD_ADp40KO", test_gene = "C130073E24Rik")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test_without_zero3(compare = "ADp40KO_WT", test_gene = "C130073E24Rik")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest_without_zero(compare = "AD_WT", test_gene = "C130073E24Rik")

ttest <- t.test(Meg3_per[Meg3_per$exp %in% "WT", ]$gene , Meg3_per[Meg3_per$exp %in% "APPPS1", ]$gene)

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

Meg3_per2 <- hist_ttest_without_zero2(compare = "AD_ADp40KO", test_gene = "C130073E24Rik")

ttest <- t.test(Meg3_per2[Meg3_per2$exp %in% "APPPS1", ]$gene , Meg3_per2[Meg3_per2$exp %in% "APPPS1.il12b-/-", ]$gene)


g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))


Meg3_per3 <- hist_ttest_without_zero3(compare = "ADp40KO_WT", test_gene = "C130073E24Rik")

ttest <- t.test(Meg3_per3[Meg3_per3$exp %in% "WT", ]$gene , Meg3_per3[Meg3_per3$exp %in% "APPPS1.il12b-/-", ]$gene)

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

grid.arrange(g1,g2,g3,ncol =3)
```

### 6. EX

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
AD_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/Large_cell_type_EX_AD_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_Ctrl.df2 <- AD_Ctrl.df[AD_Ctrl.df$gene %in% AD_lnc, ]
# select lncRNAs
AD_Ctrl.df <- AD_Ctrl.df[AD_Ctrl.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Excitatory", ]), ]
# statistical significant
AD_Ctrl.df <- AD_Ctrl.df[which(abs(AD_Ctrl.df$logFC) > 0.25 & AD_Ctrl.df$FDR < 0.05),]


AD_ADp40KO.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/Large_cell_type_EX_AD_ADp40KO.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_ADp40KO.df2 <- AD_ADp40KO.df[AD_ADp40KO.df$gene %in% AD_lnc, ]
# select lncRNAs
AD_ADp40KO.df <- AD_ADp40KO.df[AD_ADp40KO.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Excitatory", ]), ]
# statistical significant
AD_ADp40KO.df <- AD_ADp40KO.df[which(abs(AD_ADp40KO.df$logFC) > 0.25 & AD_ADp40KO.df$FDR < 0.05),]


ADp40KO_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/Large_cell_type_EX_ADp40KO_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
ADp40KO_Ctrl.df2 <- ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$gene %in% AD_lnc, ]
# select lncRNAs
ADp40KO_Ctrl.df <- ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Excitatory", ]), ]
# statistical significant
ADp40KO_Ctrl.df <- ADp40KO_Ctrl.df[which(abs(ADp40KO_Ctrl.df$logFC) > 0.25 & ADp40KO_Ctrl.df$FDR < 0.05),]
 
genes <- c(AD_Ctrl.df[AD_Ctrl.df$logFC > 0, ]$gene, 
           ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$logFC > 0, ]$gene, AD_ADp40KO.df[AD_ADp40KO.df$logFC > 0, ]$gene,
           AD_ADp40KO.df[AD_ADp40KO.df$logFC < 0, ]$gene, 
           ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$logFC < 0, ]$gene, AD_Ctrl.df[AD_Ctrl.df$logFC < 0, ]$gene) %>% unique

```

AD vs WT

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_Ctrl.df2[,c(6:11)])
```

AD vs ADp40KO

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_ADp40KO.df2[,c(6:11)])
```

ADp40KO vs WT

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(ADp40KO_Ctrl.df2[,c(6:11)])
```

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
data9set_cleaned.SO$cell_type <- data9set_cleaned.SO@active.ident
#table(data9set_cleaned.SO$cell_type)

data9set_sub.SO <- subset(data9set_cleaned.SO, subset = cell_type %in% c("Dentate Gyrus", "CA1 Neurons", "CA2/CA3 Neuron", "Subiculum", "Neurons"))

##########################
# z-score for each sample
##########################
data9set_sub_1.SO <- subset(data9set_sub.SO, subset = sample %in% "Ctrl")
data9set_sub_2.SO <- subset(data9set_sub.SO, subset = sample %in% "AD")
data9set_sub_3.SO <- subset(data9set_sub.SO, subset = sample %in% "ADp40KO")

########################
# expression calculation
########################
df1 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_1.SO, slot = "data")))
df1$gene <- rownames(df1)
colnames(df1) <- c("WT", "gene")

df2 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_2.SO, slot = "data")))
df2$gene <- rownames(df2)
colnames(df2) <- c("APPPS1", "gene")

df3 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_3.SO, slot = "data")))
df3$gene <- rownames(df3)
colnames(df3) <- c("APPPS1.il12b-/-", "gene")

df <- merge(df1, c(df2, df3))
df$gene.1 <- NULL

ZS.df1 <- z_score_from_gene_list(data9set_sub_1.SO, genes)
colnames(ZS.df1) <- c("WT", "gene")
ZS.df2 <- z_score_from_gene_list(data9set_sub_2.SO, genes)
colnames(ZS.df2) <- c("APPPS1", "gene")
ZS.df3 <- z_score_from_gene_list(data9set_sub_3.SO, genes)
colnames(ZS.df3) <- c("APPPS1.il12b-/-", "gene")

# merge all data frame
ZS.df <- merge(ZS.df1, c(ZS.df2, ZS.df3), by = "gene")

ZS.df$gene.1 <- NULL
rownames(ZS.df) <- ZS.df$gene
ZS.df$gene <- NULL

sub_ZS.df <- apply(ZS.df, 1, function(x) (x - mean(x)) / sd(x))
sub_ZS.df <- data.frame(t(sub_ZS.df))
sub_ZS.df$gene <- rownames(sub_ZS.df)

sub_ZS.df <- gather(sub_ZS.df, sample, z_score, "WT":"APPPS1.il12b...")

sub_zs.df2 <- left_join(sub_ZS.df, df, by = "gene")

sub_zs.df2$gene <- factor(sub_zs.df2$gene, levels = genes)

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
ZS.df1 <- z_score_from_gene_list(data9set_sub_1.SO, AD_lnc)
colnames(ZS.df1) <- c("WT", "gene")
ZS.df2 <- z_score_from_gene_list(data9set_sub_2.SO, AD_lnc)
colnames(ZS.df2) <- c("APPPS1", "gene")
ZS.df3 <- z_score_from_gene_list(data9set_sub_3.SO, AD_lnc)
colnames(ZS.df3) <- c("APPPS1.il12b-/-", "gene")

# merge all data frame
ZS.df <- merge(ZS.df1, c(ZS.df2, ZS.df3), by = "gene")

ZS.df$gene.1 <- NULL
rownames(ZS.df) <- ZS.df$gene
ZS.df$gene <- NULL

sub_ZS.df <- apply(ZS.df, 1, function(x) (x - mean(x)) / sd(x))
sub_ZS.df <- data.frame(t(sub_ZS.df))
sub_ZS.df$gene <- rownames(sub_ZS.df)

sub_ZS.df <- gather(sub_ZS.df, sample, z_score, "WT":"APPPS1.il12b...")

sub_zs.df2 <- left_join(sub_ZS.df, df, by = "gene")

sub_zs.df2$gene <- factor(sub_zs.df2$gene, levels = AD_lnc)

sub_zs.df2$cell_type <- "Excitatory"

AD_lnc_EX <- sub_zs.df2

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
g1 <- ggplot(data = sub_zs.df2, mapping = aes(x = sample, y = gene, fill = z_score)) +
  geom_tile() + scale_y_discrete(position = "right")  + coord_flip() +  theme_classic() + theme(plot.title = element_text(size = 15, hjust = 0.5), 
                                        axis.title.y = element_blank(),
                                         axis.title.x = element_blank(),
                                         axis.text.x.top = element_text(angle = 90, vjust = 0.5, size = 12, color = "black"),
                                         axis.text.y = element_text(size = 12, color = "black"),
                                         axis.line = element_line(color = "white"),
                                         axis.ticks = element_line(color = "white"),
                                         legend.title = element_text(size = 11, color = "white"),
                                         legend.text = element_text(size = 11, color = "black"),
                                         panel.spacing = unit(0, "mm"), 
                                        panel.margin= unit(c(-1.1), "mm"), 
                                        plot.margin = margin(0, 0, 0, 0, "cm"),
                                        strip.background = element_blank(),
                                        strip.text.x = element_text(size = .2, color = "white")) + 
  #scale_fill_gradient2(low="red", high='blue', mid="white", midpoint = 0) +  
  #scale_fill_gradientn("expression", colours = c("#003366", "#FFCC66", "#990000"), limits = c(-1.5, 1.5), oob=squish)
  scale_fill_viridis_c("expression", limits=c(-1.5, 1.5), na.value = "#FDE725FF", labels = c("-1.5", "-1.0", "-0.5","0","0.5","1.0", "1.5"), oob=squish)

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
sub_zs.df3 <- sub_zs.df2[,c(1:2, 4:6)]

sub_zs.df3 <- gather(sub_zs.df3, sample, expression, "WT":"APPPS1.il12b...")

g2 <- ggplot(data = sub_zs.df3, mapping = aes(x = sample, y = gene, fill = expression)) +
  geom_tile() + scale_y_discrete(position = "right")  + coord_flip() +  theme_classic() +
  theme(plot.title = element_text(size = 15, hjust = 0.5), 
                                        axis.title.y = element_blank(),
                                         axis.title.x = element_blank(),
                                         axis.text.x = element_blank(),
                                         axis.text.y = element_text(size = 12, color = "black"),
                                         axis.line = element_line(color = "white"),
                                         axis.ticks = element_line(color = "white"),
                                         legend.title = element_text(size = 11, color = "black"),
                                         legend.text = element_text(size = 11, color = "black"),
                                         panel.spacing = unit(0, "mm"), 
                                        panel.margin= unit(c(-1.1), "mm"), 
                                        plot.margin = margin(0, 0, 0, 0, "cm"),
                                        strip.background = element_blank(),
                                        strip.text.x = element_text(size = 10, color = "black")) + 
  #scale_fill_gradient2(low="red", high='blue', mid="white", midpoint = 0) +  
  scale_fill_gradientn("expression", colours = c("#003366", "#FFCC66", "#990000"), limits = c(0, 3), oob=squish)



grid.arrange(g1, g2, ncol = 1, heights=c(5,2))
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
perm_df1 <- as.data.frame(GetAssayData(data9set_sub_1.SO, slot = "data"))
perm_df2 <- as.data.frame(GetAssayData(data9set_sub_2.SO, slot = "data"))
perm_df3 <- as.data.frame(GetAssayData(data9set_sub_3.SO, slot = "data"))



Meg3_per <- permutation_test(compare = "AD_WT", test_gene = "A330008L17Rik")


g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Excitatory A330008L17Rik AD vs WT")

Meg3_per2 <- permutation_test2(compare = "AD_ADp40KO", test_gene = "A330008L17Rik")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Excitatory A330008L17Rik AD vs ADp40KO")

Meg3_per3 <- permutation_test3(compare = "ADp40KO_WT", test_gene = "A330008L17Rik")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Excitatory A330008L17Rik ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest(compare = "AD_WT", test_gene = "A330008L17Rik")

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

Meg3_per2 <- hist_ttest2(compare = "AD_ADp40KO", test_gene = "A330008L17Rik")

g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()


Meg3_per3 <- hist_ttest3(compare = "ADp40KO_WT", test_gene = "A330008L17Rik")

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

grid.arrange(g1,g2,g3,ncol =3)
```

Test without zero counts

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}

Meg3_per <- permutation_test_without_zero(compare = "AD_WT", test_gene = "A330008L17Rik")
g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test_without_zero2(compare = "AD_ADp40KO", test_gene = "A330008L17Rik")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test_without_zero3(compare = "ADp40KO_WT", test_gene = "A330008L17Rik")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest_without_zero(compare = "AD_WT", test_gene = "A330008L17Rik")

ttest <- t.test(Meg3_per[Meg3_per$exp %in% "WT", ]$gene , Meg3_per[Meg3_per$exp %in% "APPPS1", ]$gene)

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

Meg3_per2 <- hist_ttest_without_zero2(compare = "AD_ADp40KO", test_gene = "A330008L17Rik")

ttest <- t.test(Meg3_per2[Meg3_per2$exp %in% "APPPS1", ]$gene , Meg3_per2[Meg3_per2$exp %in% "APPPS1.il12b-/-", ]$gene)


g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))


Meg3_per3 <- hist_ttest_without_zero3(compare = "ADp40KO_WT", test_gene = "A330008L17Rik")

ttest <- t.test(Meg3_per3[Meg3_per3$exp %in% "WT", ]$gene , Meg3_per3[Meg3_per3$exp %in% "APPPS1.il12b-/-", ]$gene)

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- permutation_test(compare = "AD_WT", test_gene = "Gm10754")


g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Excitatory Gm10754 AD vs WT")

Meg3_per2 <- permutation_test2(compare = "AD_ADp40KO", test_gene = "Gm10754")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Excitatory Gm10754 AD vs ADp40KO")

Meg3_per3 <- permutation_test3(compare = "ADp40KO_WT", test_gene = "Gm10754")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Excitatory Gm10754 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest(compare = "AD_WT", test_gene = "Gm10754")

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

Meg3_per2 <- hist_ttest2(compare = "AD_ADp40KO", test_gene = "Gm10754")

g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()


Meg3_per3 <- hist_ttest3(compare = "ADp40KO_WT", test_gene = "Gm10754")

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

grid.arrange(g1,g2,g3,ncol =3)
```

Test without zero counts

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}

Meg3_per <- permutation_test_without_zero(compare = "AD_WT", test_gene = "Gm10754")
g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm10754")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm10754")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest_without_zero(compare = "AD_WT", test_gene = "Gm10754")

ttest <- t.test(Meg3_per[Meg3_per$exp %in% "WT", ]$gene , Meg3_per[Meg3_per$exp %in% "APPPS1", ]$gene)

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

Meg3_per2 <- hist_ttest_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm10754")

ttest <- t.test(Meg3_per2[Meg3_per2$exp %in% "APPPS1", ]$gene , Meg3_per2[Meg3_per2$exp %in% "APPPS1.il12b-/-", ]$gene)


g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))


Meg3_per3 <- hist_ttest_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm10754")

ttest <- t.test(Meg3_per3[Meg3_per3$exp %in% "WT", ]$gene , Meg3_per3[Meg3_per3$exp %in% "APPPS1.il12b-/-", ]$gene)

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

grid.arrange(g1,g2,g3,ncol =3)
```

### 7. Subiculumn

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
AD_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/subiculum_AD_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_Ctrl.df2 <- AD_Ctrl.df[AD_Ctrl.df$gene %in% AD_lnc, ]
# select lncRNAs
AD_Ctrl.df <- AD_Ctrl.df[AD_Ctrl.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Excitatory", ]), ]
# statistical significant
AD_Ctrl.df <- AD_Ctrl.df[which(abs(AD_Ctrl.df$logFC) > 0.25 & AD_Ctrl.df$FDR < 0.05),]


AD_ADp40KO.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/subiculum_AD_ADp40KO.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
AD_ADp40KO.df2 <- AD_ADp40KO.df[AD_ADp40KO.df$gene %in% AD_lnc, ]
# select lncRNAs
AD_ADp40KO.df <- AD_ADp40KO.df[AD_ADp40KO.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Excitatory", ]), ]
# statistical significant
AD_ADp40KO.df <- AD_ADp40KO.df[which(abs(AD_ADp40KO.df$logFC) > 0.25 & AD_ADp40KO.df$FDR < 0.05),]


ADp40KO_Ctrl.df <- read.csv("/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/DE_csv_files/edgeR/cell_type/subiculum_ADp40KO_Ctrl.csv", row.names = 1, stringsAsFactors = FALSE)
# AD genes
ADp40KO_Ctrl.df2 <- ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$gene %in% AD_lnc, ]
# select lncRNAs
ADp40KO_Ctrl.df <- ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$gene %in% rownames(avg_lncRNA_z_score.df[avg_lncRNA_z_score.df$cell_type_specific %in% "Excitatory", ]), ]
# statistical significant
ADp40KO_Ctrl.df <- ADp40KO_Ctrl.df[which(abs(ADp40KO_Ctrl.df$logFC) > 0.25 & ADp40KO_Ctrl.df$FDR < 0.05),]
 
genes <- c(AD_Ctrl.df[AD_Ctrl.df$logFC > 0, ]$gene, 
           ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$logFC > 0, ]$gene, AD_ADp40KO.df[AD_ADp40KO.df$logFC > 0, ]$gene,
           AD_ADp40KO.df[AD_ADp40KO.df$logFC < 0, ]$gene, 
           ADp40KO_Ctrl.df[ADp40KO_Ctrl.df$logFC < 0, ]$gene, AD_Ctrl.df[AD_Ctrl.df$logFC < 0, ]$gene) %>% unique

genes <- c(genes, c("Rmst"))
```

AD vs WT

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_Ctrl.df2[,c(6:11)])
```

AD vs ADp40KO

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(AD_ADp40KO.df2[,c(6:11)])
```

ADp40KO vs WT

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
datatable(ADp40KO_Ctrl.df2[,c(6:11)])
```

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
meta.df <- data9set_cleaned.SO@meta.data %>% mutate(cell_type = case_when(seurat_clusters %in% c(0, 10) ~ "Dentate_Gyrus",
                                                                                             seurat_clusters %in% c(2, 13, 18, 40) ~ "CA1",
                                                                                             seurat_clusters %in% c(9, 21, 27, 32) ~ "CA2_3",
                                                                                             seurat_clusters %in% c(11, 14, 15, 17, 19, 20) ~ "subiculum",
                                                                                             seurat_clusters %in% c(24, 29) ~ "Unidentified_Neurons",
                                                                                             seurat_clusters %in% c(7, 16, 22, 30) ~ "Inhibitory_Neurons",
                                                                                             seurat_clusters %in% c(6) ~ "MOL",
                                                                                             seurat_clusters %in% c(1, 5) ~ "MFOL",
                                                                                             seurat_clusters %in% c(12) ~ "NFOL",
                                                                                             seurat_clusters %in% c(38) ~ "OPC",
                                                                                             seurat_clusters %in% c(3, 8) ~ "Microglia",
                                                                                             seurat_clusters %in% c(4) ~ "Astrocytes",
                                                                                             seurat_clusters %in% c(36) ~ "Vascular",
                                                                                             seurat_clusters %in% c(39) ~ "VLMC",
                                                                                             seurat_clusters %in% c(26) ~ "Choroid",
                                                                                             seurat_clusters %in% c(23) ~ "Fibroblast",
                                                                                             seurat_clusters %in% c(28) ~ "Cajal",
                                                                                             seurat_clusters %in% c(35) ~ "Pericyte",
                                                                                             seurat_clusters %in% c(37) ~ "Macrophage"))


data9set_cleaned.SO$cell_type <- meta.df$cell_type

# give levels to large cell type
data9set_cleaned.SO$cell_type <- factor(data9set_cleaned.SO$cell_type, levels = c("Dentate_Gyrus", "CA1", "CA2_3", "subiculum",  "Unidentified_Neurons", 
                                                                                  "Inhibitory_Neurons", "MOL", "MFOL", "OPC", "NFOL", "Microglia","Astrocytes",
                                                                                  "Vascular", "VLMC", "Choroid", "Fibroblast", "Cajal", "Pericyte", "Macrophage"))

```

```{r warning=FALSE, message=FALSE, fig.height=8, fig.width=10}
data9set_sub.SO <- subset(data9set_cleaned.SO, subset = cell_type %in% c("subiculum"))

##########################
# z-score for each sample
##########################
data9set_sub_1.SO <- subset(data9set_sub.SO, subset = sample %in% "Ctrl")
data9set_sub_2.SO <- subset(data9set_sub.SO, subset = sample %in% "AD")
data9set_sub_3.SO <- subset(data9set_sub.SO, subset = sample %in% "ADp40KO")

########################
# expression calculation
########################
df1 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_1.SO, slot = "data")))
df1$gene <- rownames(df1)
colnames(df1) <- c("WT", "gene")

df2 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_2.SO, slot = "data")))
df2$gene <- rownames(df2)
colnames(df2) <- c("APPPS1", "gene")

df3 <- as.data.frame(Matrix::rowMeans(GetAssayData(data9set_sub_3.SO, slot = "data")))
df3$gene <- rownames(df3)
colnames(df3) <- c("APPPS1.il12b-/-", "gene")

df <- merge(df1, c(df2, df3))
df$gene.1 <- NULL

ZS.df1 <- z_score_from_gene_list(data9set_sub_1.SO, genes)
colnames(ZS.df1) <- c("WT", "gene")
ZS.df2 <- z_score_from_gene_list(data9set_sub_2.SO, genes)
colnames(ZS.df2) <- c("APPPS1", "gene")
ZS.df3 <- z_score_from_gene_list(data9set_sub_3.SO, genes)
colnames(ZS.df3) <- c("APPPS1.il12b-/-", "gene")

# merge all data frame
ZS.df <- merge(ZS.df1, c(ZS.df2, ZS.df3), by = "gene")

ZS.df$gene.1 <- NULL
rownames(ZS.df) <- ZS.df$gene
ZS.df$gene <- NULL

sub_ZS.df <- apply(ZS.df, 1, function(x) (x - mean(x)) / sd(x))
sub_ZS.df <- data.frame(t(sub_ZS.df))
sub_ZS.df$gene <- rownames(sub_ZS.df)

sub_ZS.df <- gather(sub_ZS.df, sample, z_score, "WT":"APPPS1.il12b...")

sub_zs.df2 <- left_join(sub_ZS.df, df, by = "gene")

sub_zs.df2$gene <- factor(sub_zs.df2$gene, levels = genes)

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
ZS.df1 <- z_score_from_gene_list(data9set_sub_1.SO, AD_lnc)
colnames(ZS.df1) <- c("WT", "gene")
ZS.df2 <- z_score_from_gene_list(data9set_sub_2.SO, AD_lnc)
colnames(ZS.df2) <- c("APPPS1", "gene")
ZS.df3 <- z_score_from_gene_list(data9set_sub_3.SO, AD_lnc)
colnames(ZS.df3) <- c("APPPS1.il12b-/-", "gene")

# merge all data frame
ZS.df <- merge(ZS.df1, c(ZS.df2, ZS.df3), by = "gene")

ZS.df$gene.1 <- NULL
rownames(ZS.df) <- ZS.df$gene
ZS.df$gene <- NULL

sub_ZS.df <- apply(ZS.df, 1, function(x) (x - mean(x)) / sd(x))
sub_ZS.df <- data.frame(t(sub_ZS.df))
sub_ZS.df$gene <- rownames(sub_ZS.df)

sub_ZS.df <- gather(sub_ZS.df, sample, z_score, "WT":"APPPS1.il12b...")

sub_zs.df2 <- left_join(sub_ZS.df, df, by = "gene")

sub_zs.df2$gene <- factor(sub_zs.df2$gene, levels = AD_lnc)

sub_zs.df2$cell_type <- "subiculum"

AD_lnc_SB <- sub_zs.df2

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
g1 <- ggplot(data = sub_zs.df2, mapping = aes(x = sample, y = gene, fill = z_score)) +
  geom_tile() + scale_y_discrete(position = "right")  + coord_flip() +  theme_classic() + theme(plot.title = element_text(size = 15, hjust = 0.5), 
                                        axis.title.y = element_blank(),
                                         axis.title.x = element_blank(),
                                         axis.text.x.top = element_text(angle = 90, vjust = 0.5, size = 12, color = "black"),
                                         axis.text.y = element_text(size = 12, color = "black"),
                                         axis.line = element_line(color = "white"),
                                         axis.ticks = element_line(color = "white"),
                                         legend.title = element_text(size = 11, color = "white"),
                                         legend.text = element_text(size = 11, color = "black"),
                                         panel.spacing = unit(0, "mm"), 
                                        panel.margin= unit(c(-1.1), "mm"), 
                                        plot.margin = margin(0, 0, 0, 0, "cm"),
                                        strip.background = element_blank(),
                                        strip.text.x = element_text(size = .2, color = "white")) + 
  #scale_fill_gradient2(low="red", high='blue', mid="white", midpoint = 0) +  
  #scale_fill_gradientn("expression", colours = c("#003366", "#FFCC66", "#990000"), limits = c(-1.5, 1.5), oob=squish)
  scale_fill_viridis_c("expression", limits=c(-1.5, 1.5), na.value = "#FDE725FF", labels = c("-1.5", "-1.0", "-0.5","0","0.5","1.0", "1.5"), oob=squish)

```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=10}
sub_zs.df3 <- sub_zs.df2[,c(1:2, 4:6)]

sub_zs.df3 <- gather(sub_zs.df3, sample, expression, "WT":"APPPS1.il12b...")

g2 <- ggplot(data = sub_zs.df3, mapping = aes(x = sample, y = gene, fill = expression)) +
  geom_tile() + scale_y_discrete(position = "right")  + coord_flip() +  theme_classic() +
  theme(plot.title = element_text(size = 15, hjust = 0.5), 
                                        axis.title.y = element_blank(),
                                         axis.title.x = element_blank(),
                                         axis.text.x = element_blank(),
                                         axis.text.y = element_text(size = 12, color = "black"),
                                         axis.line = element_line(color = "white"),
                                         axis.ticks = element_line(color = "white"),
                                         legend.title = element_text(size = 11, color = "black"),
                                         legend.text = element_text(size = 11, color = "black"),
                                         panel.spacing = unit(0, "mm"), 
                                        panel.margin= unit(c(-1.1), "mm"), 
                                        plot.margin = margin(0, 0, 0, 0, "cm"),
                                        strip.background = element_blank(),
                                        strip.text.x = element_text(size = 10, color = "black")) + 
  #scale_fill_gradient2(low="red", high='blue', mid="white", midpoint = 0) +  
  scale_fill_gradientn("expression", colours = c("#003366", "#FFCC66", "#990000"), limits = c(0, 3), oob=squish)



grid.arrange(g1, g2, ncol = 1, heights=c(5,2))
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
perm_df1 <- as.data.frame(GetAssayData(data9set_sub_1.SO, slot = "data"))
perm_df2 <- as.data.frame(GetAssayData(data9set_sub_2.SO, slot = "data"))
perm_df3 <- as.data.frame(GetAssayData(data9set_sub_3.SO, slot = "data"))



Meg3_per <- permutation_test(compare = "AD_WT", test_gene = "Rmst")


g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("subiculum Rmst AD vs WT")

Meg3_per2 <- permutation_test2(compare = "AD_ADp40KO", test_gene = "Rmst")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("subiculum Rmst AD vs ADp40KO")

Meg3_per3 <- permutation_test3(compare = "ADp40KO_WT", test_gene = "Rmst")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("subiculum Rmst ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest(compare = "AD_WT", test_gene = "Rmst")

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

Meg3_per2 <- hist_ttest2(compare = "AD_ADp40KO", test_gene = "Rmst")

g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()


Meg3_per3 <- hist_ttest3(compare = "ADp40KO_WT", test_gene = "Rmst")

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

grid.arrange(g1,g2,g3,ncol =3)
```

Test without zero counts

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}

Meg3_per <- permutation_test_without_zero(compare = "AD_WT", test_gene = "Rmst")
g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test_without_zero2(compare = "AD_ADp40KO", test_gene = "Rmst")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test_without_zero3(compare = "ADp40KO_WT", test_gene = "Rmst")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest_without_zero(compare = "AD_WT", test_gene = "Rmst")

ttest <- t.test(Meg3_per[Meg3_per$exp %in% "WT", ]$gene , Meg3_per[Meg3_per$exp %in% "APPPS1", ]$gene)

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

Meg3_per2 <- hist_ttest_without_zero2(compare = "AD_ADp40KO", test_gene = "Rmst")

ttest <- t.test(Meg3_per2[Meg3_per2$exp %in% "APPPS1", ]$gene , Meg3_per2[Meg3_per2$exp %in% "APPPS1.il12b-/-", ]$gene)


g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))


Meg3_per3 <- hist_ttest_without_zero3(compare = "ADp40KO_WT", test_gene = "Rmst")

ttest <- t.test(Meg3_per3[Meg3_per3$exp %in% "WT", ]$gene , Meg3_per3[Meg3_per3$exp %in% "APPPS1.il12b-/-", ]$gene)

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

grid.arrange(g1,g2,g3,ncol =3)
```


```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- permutation_test(compare = "AD_WT", test_gene = "Gm10649")


g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("subiculum Gm10649 AD vs WT")

Meg3_per2 <- permutation_test2(compare = "AD_ADp40KO", test_gene = "Gm10649")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("subiculum Gm10649 AD vs ADp40KO")

Meg3_per3 <- permutation_test3(compare = "ADp40KO_WT", test_gene = "Gm10649")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("subiculum Gm10649 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest(compare = "AD_WT", test_gene = "Gm10649")

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

Meg3_per2 <- hist_ttest2(compare = "AD_ADp40KO", test_gene = "Gm10649")

g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()


Meg3_per3 <- hist_ttest3(compare = "ADp40KO_WT", test_gene = "Gm10649")

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + scale_y_log10()

grid.arrange(g1,g2,g3,ncol =3)
```

Test without zero counts

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}

Meg3_per <- permutation_test_without_zero(compare = "AD_WT", test_gene = "Gm10649")
g1 <- ggplot(Meg3_per[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs WT")

Meg3_per2 <- permutation_test_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm10649")

g2 <- ggplot(Meg3_per2[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per2[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 AD vs ADp40KO")

Meg3_per3 <- permutation_test_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm10649")

g3 <- ggplot(Meg3_per3[c(1:1000), ], aes(x=res)) + 
  geom_histogram(color="black", fill="white") + 
  geom_vline(aes(xintercept=Meg3_per3[c(1001), ]$res),
            color="blue", linetype="dashed", size=1) + xlab("normalized count difference") + 
  ggtitle("Microglia Gm26520 ADp40KO vs WT")

grid.arrange(g1,g2,g3,ncol =3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=15}
Meg3_per <- hist_ttest_without_zero(compare = "AD_WT", test_gene = "Gm10649")

ttest <- t.test(Meg3_per[Meg3_per$exp %in% "WT", ]$gene , Meg3_per[Meg3_per$exp %in% "APPPS1", ]$gene)

g1 <- ggplot(Meg3_per, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

Meg3_per2 <- hist_ttest_without_zero2(compare = "AD_ADp40KO", test_gene = "Gm10649")

ttest <- t.test(Meg3_per2[Meg3_per2$exp %in% "APPPS1", ]$gene , Meg3_per2[Meg3_per2$exp %in% "APPPS1.il12b-/-", ]$gene)


g2 <- ggplot(Meg3_per2, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))


Meg3_per3 <- hist_ttest_without_zero3(compare = "ADp40KO_WT", test_gene = "Gm10649")

ttest <- t.test(Meg3_per3[Meg3_per3$exp %in% "WT", ]$gene , Meg3_per3[Meg3_per3$exp %in% "APPPS1.il12b-/-", ]$gene)

g3 <- ggplot(Meg3_per3, aes(x=gene, color=exp)) +
  geom_histogram(fill="white", alpha=0.5, position="identity") + ggtitle(paste0("p-value: ", ttest$p.value))

grid.arrange(g1,g2,g3,ncol =3)
```


### 8. specific lncRNAs

In here, specific and interesting lncRNAs in data

```{r warning=FALSE, message=FALSE, fig.height=12, fig.width=15}
f1 <- FeaturePlot(data9set_cleaned.SO, features = "Neat1")
f2 <- FeaturePlot(data9set_cleaned.SO, features = "Meg3")
f3 <- FeaturePlot(data9set_cleaned.SO, features = "Rmst")
f4 <- FeaturePlot(data9set_cleaned.SO, features = "Dlx6os1")
f5 <- FeaturePlot(data9set_cleaned.SO, features = "Gm2629")
f6 <- FeaturePlot(data9set_cleaned.SO, features = "Gm6145")
f7 <- FeaturePlot(data9set_cleaned.SO, features = "Sox2ot")
f8 <- FeaturePlot(data9set_cleaned.SO, features = "Miat")
f9 <- FeaturePlot(data9set_cleaned.SO, features = "Snhg1", order = TRUE)

# f10 <- FeaturePlot(data9set_cleaned.SO, features = "Pvt1", order = TRUE)
# 
# ggsave(filename = "/data/rajewsky/home/skim/Microglia_Heppner/201912_10X_9sets/R_Scripts/20200913_lncRNA_3rd_analysis/Pvt1_UMAP.png", 
#        plot = f10, 
#        scale = 1, width = 7, height = 5.5, units = "in", device = "png",
#        dpi = 300)

grid.arrange(f1, f2, f3, f4, f5, f6, f7, f8, f9, ncol = 3)
```

```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=12}
AD_lnc.df <- rbind(AD_lnc_AS, AD_lnc_EX, AD_lnc_IN, AD_lnc_MG, AD_lnc_OL, AD_lnc_SB)

AD_lnc.df$sample <- factor(AD_lnc.df$sample, levels = c("WT", "APPPS1", "APPPS1.il12b..."))

AD_lnc.df$cell_type <- factor(AD_lnc.df$cell_type, levels = c("Astrocytes", "Microglia", "Oligo", "Excitatory","subiculum", "Inhibitory"))


ggplot(data = AD_lnc.df, mapping = aes(x = sample, y = cell_type, fill = z_score)) +
  geom_tile() + scale_y_discrete(position = "right")  + facet_grid(~gene, scales = "free_x", space = "free_x", switch = 'x')+ 
  theme_classic() + theme(plot.title = element_text(size = 15, hjust = 0.5), 
                                         axis.title.y = element_blank(),
                                         axis.title.x = element_blank(),
                                         axis.text.x = element_text(size = 12, color = "black", angle = 60, vjust = 0.5),
                                         axis.text.x.top = element_text(angle = 90, vjust = 0.5, size = 12, color = "black"),
                                         axis.text.y = element_text(size = 12, color = "black"),
                                         axis.line = element_line(color = "white"),
                                         axis.ticks = element_line(color = "white"),
                                         legend.title = element_text(size = 11, color = "white"),
                                         legend.text = element_text(size = 11, color = "black"),
                                         panel.spacing = unit(0, "mm"), 
                                        panel.margin= unit(c(-1.1), "mm"), 
                                        plot.margin = margin(0, 0, 0, 0, "cm"),
                                        strip.background = element_blank(),
                                        strip.text.x = element_text(size = 10, color = "black")) + 
  #scale_fill_gradient2(low="red", high='blue', mid="white", midpoint = 0) +  
  #scale_fill_gradientn("expression", colours = c("#003366", "#FFCC66", "#990000"), limits = c(-1.5, 1.5), oob=squish)
  scale_fill_viridis_c("expression", limits=c(-1.5, 1.5), na.value = "#FDE725FF", labels = c("-1.5", "-1.0", "-0.5","0","0.5","1.0", "1.5"), oob=squish)

```


```{r warning=FALSE, message=FALSE, fig.height=4, fig.width=3}
sessionInfo()
````